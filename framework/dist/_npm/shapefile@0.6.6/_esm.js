/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/shapefile@0.6.6/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import t from"../path-source@0.1.3/_esm.js";import n from"../array-source@0.0.4/_esm.js";import e from"../stream-source@0.3.5/_esm.js";import r from"../slice-source@0.4.1/_esm.js";function o(t){return!(t=t.trim())||isNaN(t=+t)?null:t}var i={B:o,C:function(t){return t.trim()||null},D:function(t){return new Date(+t.substring(0,4),t.substring(4,6)-1,+t.substring(6,8))},F:o,L:function(t){return!/^[nf]$/i.test(t)&&(!!/^[yt]$/i.test(t)||null)},M:o,N:o};function u(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function a(t,n){return(t=r(t)).slice(32).then((function(e){var r=u(e);return t.slice(r.getUint16(8,!0)-32).then((function(e){return new c(t,n,r,u(e))}))}))}function c(t,n,e,r){this._source=t,this._decode=n.decode.bind(n),this._recordLength=e.getUint16(10,!0),this._fields=[];for(var o=0;13!==r.getUint8(o);o+=32){for(var i=0;i<11&&0!==r.getUint8(o+i);++i);this._fields.push({name:this._decode(new Uint8Array(r.buffer,r.byteOffset+o,i)),type:String.fromCharCode(r.getUint8(o+11)),length:r.getUint8(o+16)})}}var f=c.prototype;function s(t){var n,e=40,r=t.getInt32(36,!0),o=new Array(r);for(n=0;n<r;++n,e+=16)o[n]=[t.getFloat64(e,!0),t.getFloat64(e+8,!0)];return{type:"MultiPoint",coordinates:o}}function l(t){return{type:"Point",coordinates:[t.getFloat64(4,!0),t.getFloat64(12,!0)]}}function h(t){var n,e=44,r=t.getInt32(36,!0),o=t.getInt32(40,!0),i=new Array(r),u=new Array(o),a=[],c=[];for(n=0;n<r;++n,e+=4)i[n]=t.getInt32(e,!0);for(n=0;n<o;++n,e+=16)u[n]=[t.getFloat64(e,!0),t.getFloat64(e+8,!0)];return i.forEach((function(t,n){var e=u.slice(t,i[n+1]);!function(t){if((n=t.length)<4)return!1;var n,e=0,r=t[n-1][1]*t[0][0]-t[n-1][0]*t[0][1];for(;++e<n;)r+=t[e-1][1]*t[e][0]-t[e-1][0]*t[e][1];return r>=0}(e)?c.push(e):a.push([e])})),c.forEach((function(t){a.some((function(n){if(function(t,n){var e,r=-1,o=n.length;for(;++r<o;)if(e=d(t,n[r]))return e>0;return!1}(n[0],t))return n.push(t),!0}))||a.push([t])})),1===a.length?{type:"Polygon",coordinates:a[0]}:{type:"MultiPolygon",coordinates:a}}function d(t,n){for(var e=n[0],r=n[1],o=-1,i=0,u=t.length,a=u-1;i<u;a=i++){var c=t[i],f=c[0],s=c[1],l=t[a],h=l[0],d=l[1];if(g(c,l,n))return 0;s>r!=d>r&&e<(h-f)*(r-s)/(d-s)+f&&(o=-o)}return o}function g(t,n,e){var r=e[0]-t[0],o=e[1]-t[1];if(0===r&&0===o)return!0;var i=n[0]-t[0],u=n[1]-t[1];if(0===i&&0===u)return!1;var a=(r*i+o*u)/(i*i+u*u);return!(a<0||a>1)&&(0===a||1===a||a*i===r&&a*u===o)}function p(t){var n,e=44,r=t.getInt32(36,!0),o=t.getInt32(40,!0),i=new Array(r),u=new Array(o);for(n=0;n<r;++n,e+=4)i[n]=t.getInt32(e,!0);for(n=0;n<o;++n,e+=16)u[n]=[t.getFloat64(e,!0),t.getFloat64(e+8,!0)];return 1===r?{type:"LineString",coordinates:u}:{type:"MultiLineString",coordinates:i.map((function(t,n){return u.slice(t,i[n+1])}))}}function v(t,n){var e=new Uint8Array(t.length+n.length);return e.set(t,0),e.set(n,t.length),e}f.read=function(){var t=this,n=1;return t._source.slice(t._recordLength).then((function(e){return e&&26!==e[0]?{done:!1,value:t._fields.reduce((function(r,o){return r[o.name]=i[o.type](t._decode(e.subarray(n,n+=o.length))),r}),{})}:{done:!0,value:void 0}}))},f.cancel=function(){return this._source.cancel()};var y={0:function(){return null},1:l,3:p,5:h,8:s,11:l,13:p,15:h,18:s,21:l,23:p,25:h,28:s};function b(t){return(t=r(t)).slice(100).then((function(n){return new m(t,u(n))}))}function m(t,n){var e=n.getInt32(32,!0);if(!(e in y))throw new Error("unsupported shape type: "+e);this._source=t,this._type=e,this._index=0,this._parse=y[e],this.bbox=[n.getFloat64(36,!0),n.getFloat64(44,!0),n.getFloat64(52,!0),n.getFloat64(60,!0)]}var _=m.prototype;function w(){}function A(t,n,e){return Promise.all([b(t),n&&a(n,e)]).then((function(t){return new F(t[0],t[1])}))}function F(t,n){this._shp=t,this._dbf=n,this.bbox=t.bbox}_.read=function(){var t=this;return++t._index,t._source.slice(12).then((function(n){if(null==n)return{done:!0,value:void 0};var e=u(n);function r(){return t._source.slice(4).then((function(i){return null==i?{done:!0,value:void 0}:(e=u(n=v(n.slice(4),i))).getInt32(0,!1)!==t._index?r():o()}))}function o(){var o=2*e.getInt32(4,!1)-4,i=e.getInt32(8,!0);return o<0||i&&i!==t._type?r():t._source.slice(o).then((function(e){return{done:!1,value:i?t._parse(u(v(n.slice(8),e))):null}}))}return o()}))},_.cancel=function(){return this._source.cancel()};var x=F.prototype;function U(r,o,i){return"string"==typeof o?(/\.dbf$/.test(o)||(o+=".dbf"),o=t(o,i)):o instanceof ArrayBuffer||o instanceof Uint8Array?o=n(o):null!=o&&(o=e(o)),"string"==typeof r?(/\.shp$/.test(r)||(r+=".shp"),void 0===o&&(o=t(r.substring(0,r.length-4)+".dbf",i).catch((function(){}))),r=t(r,i)):r=r instanceof ArrayBuffer||r instanceof Uint8Array?n(r):e(r),Promise.all([r,o]).then((function(t){var n=t[0],e=t[1],r="windows-1252";return i&&null!=i.encoding&&(r=i.encoding),A(n,e,e&&new TextDecoder(r))}))}function I(r,o){return"string"==typeof r?(/\.shp$/.test(r)||(r+=".shp"),r=t(r,o)):r=r instanceof ArrayBuffer||r instanceof Uint8Array?n(r):e(r),Promise.resolve(r).then(b)}function P(r,o){var i="windows-1252";return o&&null!=o.encoding&&(i=o.encoding),i=new TextDecoder(i),"string"==typeof r?(/\.dbf$/.test(r)||(r+=".dbf"),r=t(r,o)):r=r instanceof ArrayBuffer||r instanceof Uint8Array?n(r):e(r),Promise.resolve(r).then((function(t){return a(t,i)}))}function L(t,n,e){return U(t,n,e).then((function(t){var n=[],e={type:"FeatureCollection",features:n,bbox:t.bbox};return t.read().then((function r(o){return o.done?e:(n.push(o.value),t.read().then(r))}))}))}x.read=function(){var t=this;return Promise.all([t._dbf?t._dbf.read():{value:{}},t._shp.read()]).then((function(t){var n=t[0],e=t[1];return e.done?e:{done:!1,value:{type:"Feature",properties:n.value,geometry:e.value}}}))},x.cancel=function(){return Promise.all([this._dbf&&this._dbf.cancel(),this._shp.cancel()]).then(w)};export{U as open,P as openDbf,I as openShp,L as read};export default null;
