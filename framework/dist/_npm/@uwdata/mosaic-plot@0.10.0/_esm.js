/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@uwdata/mosaic-plot@0.10.0/src/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{synchronizer as t,distinct as e,MosaicClient as n,toDataColumns as i,isParam as s,coordinator as r,throttle as o,clauseInterval as a,clauseIntervals as l,clausePoints as c,isSelection as h,Selection as u}from"../mosaic-core@0.10.0/_esm.js";import*as p from"../../@observablehq/plot@0.6.15/_esm.js";import{interpolatorRandomWalk as d,interpolatorBarycentric as f,interpolateNearest as y,scale as g}from"../../@observablehq/plot@0.6.15/_esm.js";import{Query as m,column as x,isParamLike as b,Ref as E,scaleTransform as v,sql as A,min as w,argmin as R,max as O,argmax as L,isBetween as S,lte as k,lt as F,sum as T,count as M,neq as N,and as $,isNull as _,gt as I,avg as D,stddev as q,geojson as z,isNotNull as G,regrIntercept as B,regrSlope as P,regrCount as j,regrSYY as C,regrSXX as W,regrAvgX as U,castDouble as H,dateBin as X}from"../mosaic-sql@0.10.0/_esm.js";import{color as Y,scaleLinear as V,InternSet as Z,ascending as Q,contours as K,rgb as J,range as tt,brush as et,brushX as nt,brushY as it,min as st,max as rt,select as ot,pointer as at,zoom as lt,ZoomTransform as ct,bisector as ht}from"../../d3@7.9.0/_esm.js";const ut=Symbol("Fixed"),pt=Symbol("Transient"),dt=Symbol("Transform"),ft=new Map([["style","style"],["width","width"],["height","height"],["margin","margin"],["marginLeft","marginLeft"],["marginRight","marginRight"],["marginTop","marginTop"],["marginBottom","marginBottom"],["align","align"],["aspectRatio","aspectRatio"],["axis","axis"],["inset","inset"],["grid","grid"],["label","label"],["padding","padding"],["xScale","x.type"],["xDomain","x.domain"],["xRange","x.range"],["xNice","x.nice"],["xInset","x.inset"],["xInsetLeft","x.insetLeft"],["xInsetRight","x.insetRight"],["xClamp","x.clamp"],["xRound","x.round"],["xAlign","x.align"],["xPadding","x.padding"],["xPaddingInner","x.paddingInner"],["xPaddingOuter","x.paddingOuter"],["xAxis","x.axis"],["xTicks","x.ticks"],["xTickSize","x.tickSize"],["xTickSpacing","x.tickSpacing"],["xTickPadding","x.tickPadding"],["xTickFormat","x.tickFormat"],["xTickRotate","x.tickRotate"],["xGrid","x.grid"],["xLine","x.line"],["xLabel","x.label"],["xLabelAnchor","x.labelAnchor"],["xLabelArrow","x.labelArrow"],["xLabelOffset","x.labelOffset"],["xFontVariant","x.fontVariant"],["xAriaLabel","x.ariaLabel"],["xAriaDescription","x.ariaDescription"],["xPercent","x.percent"],["xReverse","x.reverse"],["xZero","x.zero"],["xBase","x.base"],["xExponent","x.exponent"],["xConstant","x.constant"],["yScale","y.type"],["yDomain","y.domain"],["yRange","y.range"],["yNice","y.nice"],["yInset","y.inset"],["yInsetTop","y.insetTop"],["yInsetBottom","y.insetBottom"],["yClamp","y.clamp"],["yRound","y.round"],["yAlign","y.align"],["yPadding","y.padding"],["yPaddingInner","y.paddingInner"],["yPaddingOuter","y.paddingOuter"],["yAxis","y.axis"],["yTicks","y.ticks"],["yTickSize","y.tickSize"],["yTickSpacing","y.tickSpacing"],["yTickPadding","y.tickPadding"],["yTickFormat","y.tickFormat"],["yTickRotate","y.tickRotate"],["yGrid","y.grid"],["yLine","y.line"],["yLabel","y.label"],["yLabelAnchor","y.labelAnchor"],["yLabelArrow","y.labelArrow"],["yLabelOffset","y.labelOffset"],["yFontVariant","y.fontVariant"],["yAriaLabel","y.ariaLabel"],["yAriaDescription","y.ariaDescription"],["yPercent","y.percent"],["yReverse","y.reverse"],["yZero","y.zero"],["yBase","y.base"],["yExponent","y.exponent"],["yConstant","y.constant"],["facetMargin","facet.margin"],["facetMarginTop","facet.marginTop"],["facetMarginBottom","facet.marginBottom"],["facetMarginLeft","facet.marginLeft"],["facetMarginRight","facet.marginRight"],["facetGrid","facet.grid"],["facetLabel","facet.label"],["fxDomain","fx.domain"],["fxRange","fx.range"],["fxInset","fx.inset"],["fxInsetLeft","fx.insetLeft"],["fxInsetRight","fx.insetRight"],["fxRound","fx.round"],["fxAlign","fx.align"],["fxPadding","fx.padding"],["fxPaddingInner","fx.paddingInner"],["fxPaddingOuter","fx.paddingOuter"],["fxAxis","fx.axis"],["fxTicks","fx.ticks"],["fxTickSize","fx.tickSize"],["fxTickSpacing","fx.tickSpacing"],["fxTickPadding","fx.tickPadding"],["fxTickFormat","fx.tickFormat"],["fxTickRotate","fx.tickRotate"],["fxGrid","fx.grid"],["fxLine","fx.line"],["fxLabel","fx.label"],["fxLabelAnchor","fx.labelAnchor"],["fxLabelOffset","fx.labelOffset"],["fxFontVariant","fx.fontVariant"],["fxAriaLabel","fx.ariaLabel"],["fxAriaDescription","fx.ariaDescription"],["fxReverse","fx.reverse"],["fyDomain","fy.domain"],["fyRange","fy.range"],["fyInset","fy,inset"],["fyInsetTop","fy.insetTop"],["fyInsetBottom","fy.insetBottom"],["fyRound","fy.round"],["fyAlign","fy.align"],["fyPadding","fy.padding"],["fyPaddingInner","fy.paddingInner"],["fyPaddingOuter","fy.paddingOuter"],["fyAxis","fy.axis"],["fyTicks","fy.ticks"],["fyTickSize","fy.tickSize"],["fyTickSpacing","fy.tickSpacing"],["fyTickPadding","fy.tickPadding"],["fyTickFormat","fy.tickFormat"],["fyTickRotate","fy.tickRotate"],["fyGrid","fy.grid"],["fyLine","fy.line"],["fyLabel","fy.label"],["fyLabelAnchor","fy.labelAnchor"],["fyLabelOffset","fy.labelOffset"],["fyFontVariant","fy.fontVariant"],["fyAriaLabel","fy.ariaLabel"],["fyAriaDescription","fy.ariaDescription"],["fyReverse","fy.reverse"],["colorScale","color.type"],["colorDomain","color.domain"],["colorRange","color.range"],["colorClamp","color.clamp"],["colorN","color.n"],["colorNice","color.nice"],["colorScheme","color.scheme"],["colorInterpolate","color.interpolate"],["colorPivot","color.pivot"],["colorSymmetric","color.symmetric"],["colorLabel","color.label"],["colorPercent","color.percent"],["colorReverse","color.reverse"],["colorZero","color.zero"],["colorTickFormat","color.tickFormat"],["colorBase","color.base"],["colorExponent","color.exponent"],["colorConstant","color.constant"],["opacityScale","opacity.type"],["opacityDomain","opacity.domain"],["opacityRange","opacity.range"],["opacityClamp","opacity.clamp"],["opacityNice","opacity.nice"],["opacityLabel","opacity.label"],["opacityPercent","opacity.percent"],["opacityReverse","opacity.reverse"],["opacityZero","opacity.zero"],["opacityTickFormat","opacity.tickFormat"],["opacityBase","opacity.base"],["opacityExponent","opacity.exponent"],["opacityConstant","opacity.constant"],["symbolScale","symbol.type"],["symbolDomain","symbol.domain"],["symbolRange","symbol.range"],["rScale","r.type"],["rDomain","r.domain"],["rRange","r.range"],["rClamp","r.clamp"],["rNice","r.nice"],["rLabel","r.label"],["rPercent","r.percent"],["rZero","r.zero"],["rBase","r.base"],["rExponent","r.exponent"],["rConstant","r.constant"],["lengthScale","length.type"],["lengthDomain","length.domain"],["lengthRange","length.range"],["lengthClamp","length.clamp"],["lengthNice","length.nice"],["lengthPercent","length.percent"],["lengthZero","length.zero"],["lengthBase","length.base"],["lengthExponent","length.exponent"],["lengthConstant","length.constant"],["projectionType","projection.type"],["projectionParallels","projection.parallels"],["projectionPrecision","projection.precision"],["projectionRotate","projection.rotate"],["projectionDomain","projection.domain"],["projectionInset","projection.inset"],["projectionInsetLeft","projection.insetLeft"],["projectionInsetRight","projection.insetRight"],["projectionInsetTop","projection.insetTop"],["projectionInsetBottom","projection.insetBottom"],["projectionClip","projection.clip"]]);function yt(t,e,n){for(let i=0;i<e.length;++i){const s=e[i];i===e.length-1?t[s]=n:t=t[s]||(t[s]={})}}const gt=new Set(["frame","hexgrid","sphere","graticule"]),mt=new Map([["first",p.selectFirst],["last",p.selectLast],["maxX",p.selectMaxX],["maxY",p.selectMaxY],["minX",p.selectMinX],["minY",p.selectMinY],["nearest",p.pointer],["nearestX",p.pointerX],["nearestXY",p.pointerY]]);async function xt(t){const e={marks:[]},n=[],{attributes:i,marks:s}=t;!function(t,e,n){for(const i in t){const s=ft.get(i);if(null==s)throw new Error(`Unrecognized plot attribute: ${i}`);const r=t[i];"symbol"==typeof r?n.push(i):void 0!==r&&yt(e,s.split("."),r)}}(i,e,n);const r=[];for(const t of s)for(const{type:n,data:i,options:s}of t.plotSpecs()){const{select:o,...a}=s,l=mt.get(o)?.(a)??a,c=gt.has(n)?[l]:[i,l];e.marks.push(p[n](...c)),r.push(t.index)}!function(t,e){const{marks:n}=e;bt("x",t,n),bt("y",t,n),bt("fx",t,n),bt("fy",t,n)}(e,t);const o=p.plot(e);!function(t,e){const n=t.querySelectorAll('g[aria-label="facet"]');if(n.length)for(const t of n)Et(t,e);else Et(t,e)}(o,r),function(t,e,n,i){i.forEach((i=>{const s=n[i];if(s!==ut)throw new Error(`Unrecognized symbol: ${s}`);{if(!i.endsWith("Domain"))throw new Error(`Unsupported fixed attribute: ${i}`);const s=i.slice(0,-6),r=e.scale(s);r?.domain&&t.setAttribute(i,n[`${s}Reverse`]?r.domain.slice().reverse():r.domain)}}))}(t,o,i,n);for(const e of t.interactors)await e.init(o);return o}function bt(t,e,n){const i=e[t]||{};if(null===i.axis||void 0!==i.label)return;const s=n.map((e=>e.channelField(t)?.field));if(s.every((t=>null==t)))return;let r,o,a;for(let e=0;e<s.length;++e){const{column:i,label:l}=s[e]||{};void 0===i&&void 0===l||(void 0===r&&void 0===o?(r=i,o=l,a=vt(n[e].data,t)||"number"):o!==l?o=void 0:r!==i&&(r=void 0))}let l=o||r;if(void 0!==l){if(!("number"!==a&&"date"!==a||"x"!==t&&"y"!==t)){i.percent&&(l=`${l} (%)`);const e=("x"===t?1:-1)*(i.reverse?-1:1);l="x"===t||"center"===i.labelAnchor?"x"===t==e<0?`← ${l}`:`${l} →`:`${e<0?"↑ ":"↓ "}${l}`}e[t]={...i,label:l}}}function Et(t,e){let n=-1;for(const i of t.children){const t=i.getAttribute("aria-label")||"";"style"===i.nodeName||t.includes("-axis")||t.includes("-grid")||i.setAttribute("data-index",e[++n])}}function vt(t,e){if(!t)return;const{columns:n}=t,i=n[e]??n[e+"1"]??n[e+"2"];if(i)for(const t of i)if(null!=t)return t instanceof Date?"date":typeof t}const At={width:640,marginLeft:40,marginRight:20,marginTop:20,marginBottom:30};class wt{constructor(e){this.attributes={...At},this.listeners=null,this.interactors=[],this.legends=[],this.marks=[],this.markset=null,this.element=e||document.createElement("div"),this.element.setAttribute("class","plot"),this.element.style.display="flex",this.element.value=this,this.params=new Map,this.synch=t()}margins(){return{left:this.getAttribute("marginLeft"),top:this.getAttribute("marginTop"),bottom:this.getAttribute("marginBottom"),right:this.getAttribute("marginRight")}}innerWidth(){const{left:t,right:e}=this.margins();return this.getAttribute("width")-t-e}innerHeight(t=400){const{top:e,bottom:n}=this.margins();let i=this.getAttribute("height");return null==i&&(i=function(t,e,n){const i=t.getAttribute("aspectRatio");if(null==i)return;const s=t.getAttribute("xDomain"),r=t.getAttribute("yDomain");if(!s||!r)return;const o=Math.abs(s[1]-s[0]);return Math.abs(r[1]-r[0])*t.innerWidth()/(i*o)+e+n}(this,e,n)||t,this.setAttribute("height",i,{silent:!0})),i-e-n}pending(t){this.synch.pending(t)}update(t){return this.synch.ready(t)&&!this.pendingRender&&(this.pendingRender=!0,requestAnimationFrame((()=>this.render()))),this.synch.promise}async render(){this.pendingRender=!1;const t=await xt(this),e=this.legends.flatMap((({legend:e,include:n})=>{const i=e.init(t);return n?i:[]}));this.element.replaceChildren(t,...e),this.synch.resolve()}getAttribute(t){return this.attributes[t]}setAttribute(t,n,i){return!!e(this.attributes[t],n)&&(void 0===n?delete this.attributes[t]:this.attributes[t]=n,i?.silent||this.listeners?.get(t)?.forEach((e=>e(t,n))),!0)}addAttributeListener(t,e){const n=this.listeners||(this.listeners=new Map);return n.has(t)||n.set(t,new Set),n.get(t).add(e),this}removeAttributeListener(t,e){return this.listeners?.get(t)?.delete(e)}addParams(t,e){const{params:n}=this;for(const i of e)n.has(i)?n.get(i).push(t):(n.set(i,[t]),i.addEventListener("value",(()=>Promise.allSettled(n.get(i).map((t=>t.requestQuery()))))))}addMark(t){return t.setPlot(this,this.marks.length),this.marks.push(t),this.markset=null,this}get markSet(){return this.markset||(this.markset=new Set(this.marks))}addInteractor(t){return this.interactors.push(t),this}addLegend(t,e=!0){t.setPlot(this),this.legends.push({legend:t,include:e})}}function Rt(t){return"string"==typeof t&&("none"===(t=t.toLowerCase().trim())||"currentcolor"===t||t.startsWith("url(")&&t.endsWith(")")||t.startsWith("var(")&&t.endsWith(")")||null!==Y(t))}const Ot=new Set(["order","sort","label","anchor","curve","tension","marker","markerStart","markerMid","markerEnd","textAnchor","lineAnchor","lineHeight","textOverflow","monospace","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","frameAnchor","strokeLinejoin","strokeLinecap","strokeMiterlimit","strokeDasharray","strokeDashoffset","mixBlendMode","shapeRendering","imageRendering","preserveAspectRatio","interpolate","crossOrigin","paintOrder","pointerEvents","target","select"]);const Lt=new Set(["asterisk","circle","cross","diamond","diamond2","hexagon","plus","square","square2","star","times","triangle","triangle2","wye"]);const St=t=>"stroke"===t||"fill"===t,kt=t=>/opacity$/i.test(t),Ft=(t,e)=>({channel:t,field:e,as:e instanceof E?e.column:t}),Tt=(t,e)=>({channel:t,value:e}),Mt=t=>Array.isArray(t);class Nt extends n{constructor(t,e,n,s={}){super(e?.options?.filterBy),this.type=t,this.reqs=s,this.source=e,Mt(this.source)&&(this.data=i(this.source));const r=this.channels=[],o=this.detail=new Set,a=this.params=new Set,l=(t,e)=>{const n=typeof e;if("channels"===t)for(const t in e)o.add(t),l(t,e[t]);else if("function"===n&&e[dt]){const n=e(this,t);for(const t in n)l(t,n[t])}else if("string"===n)i=t,Ot.has(i)||St(t)&&Rt(e)||(t=>"symbol"===t)(t)&&function(t){return Lt.has(`${t}`.toLowerCase())}(e)?r.push(Tt(t,e)):r.push(Ft(t,x(e)));else if(b(e))if(Array.isArray(e.columns))r.push(Ft(t,e)),a.add(e);else{const n=Tt(t,e.value);r.push(n),e.addEventListener("value",(t=>(n.value=t,this.update())))}else"object"===n&&((t,e)=>"sort"!==t&&"tip"!==t&&null!=e&&!Array.isArray(e))(t,e)?r.push(Ft(t,e)):void 0!==e&&r.push(Tt(t,e));var i};for(const t in n)l(t,n[t])}setPlot(t,e){this.plot=t,this.index=e,t.addParams(this,this.params),this.source?.table&&this.queryPending()}hasOwnData(){return null==this.source||Mt(this.source)}hasFieldInfo(){return!!this._fieldInfo}channel(t){return this.channels.find((e=>e.channel===t))}channelField(t,{exact:e=!1}={}){const n=e?this.channel(t):this.channels.find((e=>e.channel.startsWith(t)));return n?.field?n:null}fields(){if(this.hasOwnData())return null;const{source:{table:t},channels:e,reqs:n}=this,i=new Map;for(const{channel:t,field:s}of e){if(!s)continue;const e=s.stats?.stats||[],r=s.stats?.column??s,o=i.get(r)??i.set(r,new Set).get(r);e.forEach((t=>o.add(t))),n[t]?.forEach((t=>o.add(t)))}return Array.from(i,(([e,n])=>({table:t,column:e,stats:n})))}fieldInfo(t){const e=Object.fromEntries(t.map((t=>[t.column,t])));for(const t of this.channels){const{field:n}=t;n&&Object.assign(t,e[n.stats?.column??n])}return this._fieldInfo=!0,this}query(t=[]){if(this.hasOwnData())return null;const{channels:e,source:{table:n}}=this;return _t(e,n).where(t)}queryPending(){return this.plot.pending(this),this}queryResult(t){return this.data=i(t),this}update(){return this.plot.update(this)}plotSpecs(){const{type:t,data:e,detail:n,channels:i}=this;return It(t,n,i,e)}}function $t(t,e){const n=e?.[t.as]??t.as;return Object.hasOwn(t,"value")?t.value:St(t.channel)?{value:n,scale:"color"}:kt(t.channel)?{value:n,scale:"opacity"}:n}function _t(t,e,n=[]){const i=m.from({source:e}),s=new Set;let r=!1;for(const e of t){const{channel:t,field:o,as:a}=e;if(!n.includes(t))if("orderby"===t)i.orderby(e.value);else if(o){if(o.aggregate)r=!0;else{if(s.has(a))continue;s.add(a)}i.select({[a]:o})}}return r&&i.groupby(Array.from(s)),i}function It(t,e,n,i,s={}){const{numRows:r,values:o,columns:a}=i??{},l={};for(const t of n){(e.has(t.channel)?l:s)[t.channel]=$t(t,a)}e.size&&(s.channels=l);return[{type:t,data:o??(i?{length:r}:null),options:s}]}function Dt(t,e){const{plot:n}=t;let i=n.getAttribute(`${e}Scale`);if(!i){const{type:n}=t.channelField(e);i="date"===n?"time":"linear"}const s={type:i};switch(i){case"log":s.base=n.getAttribute(`${e}Base`)??10;break;case"pow":s.exponent=n.getAttribute(`${e}Exponent`)??1;break;case"symlog":s.constant=n.getAttribute(`${e}Constant`)??1}return v(s)}function qt(t,e,n,i,s=1,r){const{field:o}=t.channelField(e);r=r??o;const{type:a,apply:l,sqlApply:c}=Dt(t,e),h=!!t.plot.getAttribute(`${e}Reverse`),[u,p]=i.map((t=>l(t))),d=c(r),f=p===u?0:(n-s)/(p-u),y=1!==f?` * ${f}::DOUBLE`:"";return[h?A`(${p} - ${d}::DOUBLE)${y}`:A`(${d}::DOUBLE - ${u})${y}`,"time"===a||"utc"===a?d:r]}const zt={x:["min","max"]},Gt={y:["min","max"]},Bt={...zt,...Gt};function Pt(t,e,n,i,s){const{plot:r}=t,o=r.getAttribute(i),a=r.getAttribute(s);if(Array.isArray(o)&&!o[pt])return o;{const{column:s,min:l,max:c}=t.channelField(n),h=Wt(e,s)||(a?V().domain([l,c]).nice().domain():[l,c]);return o!==ut&&(h[pt]=!0),r.setAttribute(i,h,{silent:!0}),h}}function jt(t,e){return Pt(t,e,"x","xDomain","xNice")}function Ct(t,e){return Pt(t,e,"y","yDomain","yNice")}function Wt(t,e){if(!t)return;let n,i;const s=(t,s)=>{if("BETWEEN"===t&&`${s.field}`===e){const{range:t}=s;t&&(null==n||t[0]<n)&&(n=t[0]),t&&(null==i||t[1]>i)&&(i=t[1])}};return Array.isArray(t)?t.forEach((t=>t.visit?.(s))):t.visit&&t.visit(s),null!=n&&null!=i&&n!==i?[n,i]:void 0}class Ut extends Nt{constructor(t,e,n){const i=t.endsWith("X")?"y":t.endsWith("Y")?"x":null;super(t,e,n,i?{[i]:["min","max"]}:void 0),this.dim=i}query(t=[]){const{plot:e,dim:n,source:i}=this,{optimize:s=!0}=i.options||{},r=super.query(t);if(!n)return r;const o="x"===n?"y":"x",a=this.channelField(o,{exact:!0})?.as,{field:l,as:c,type:h,min:u,max:p}=this.channelField(n);if(s&&("date"===h||"number"===h)&&a){const i="x"===n?e.innerWidth():e.innerHeight(),[s,o]=Wt(t,l)||[u,p],[h]=qt(this,n,i,[s,o],1,c),d=r.select().map((t=>t.as)).filter((t=>t!==c&&t!==a));return Ht(r,h,c,a,d)}return r.orderby(l)}}function Ht(t,e,n,i,s=[]){const r=A`FLOOR(${e})::INTEGER`,o=e=>m.from(t).select(e).groupby(r,s);return m.union(o([{[n]:w(n),[i]:R(i,n)},...s]),o([{[n]:O(n),[i]:L(i,n)},...s]),o([{[n]:R(n,i),[i]:w(i)},...s]),o([{[n]:L(n,i),[i]:O(i)},...s])).orderby(s,n)}function Xt(t,e=[]){return new e.constructor(t)}function Yt(t){let e=1/0,n=-1/0;return t.forEach((t=>{const i=t.length;for(let s=0;s<i;++s){const i=t[s];i<e&&(e=i),i>n&&(n=i)}})),Number.isFinite(e)&&Number.isFinite(n)?[e,n]:[0,1]}function Vt(t,e){return s(t)?(t.addEventListener("value",e),t.value):t}function Zt(t,e=!1){const n=new Float64Array(5),i=new Float64Array(4);!function(t,e,n){const i=4,s=Float64Array.of(.84,1.8675,.84,-1.8675,-.34015,-.1299,-.34015,.1299),r=Math.exp(-1.783/n),o=Math.exp(-1.723/n),a=.6318/n,l=1.997/n,c=Float64Array.of(-r*Math.cos(a),r*Math.sin(a),-r*Math.cos(-a),r*Math.sin(-a),-o*Math.cos(l),o*Math.sin(l),-o*Math.cos(-l),o*Math.sin(-l)),h=2.5066282746310007*n,u=Float64Array.of(s[0],s[1],0,0,0,0,0,0),p=Float64Array.of(1,0,c[0],c[1],0,0,0,0,0,0);let d,f;for(f=2;f<8;f+=2){for(u[f]=c[f]*u[f-2]-c[f+1]*u[f-1],u[f+1]=c[f]*u[f-1]+c[f+1]*u[f-2],d=f-2;d>0;d-=2)u[d]+=c[f]*u[d-2]-c[f+1]*u[d-1],u[d+1]+=c[f]*u[d-1]+c[f+1]*u[d-2];for(d=0;d<=f;d+=2)u[d]+=s[f]*p[d]-s[f+1]*p[d+1],u[d+1]+=s[f]*p[d+1]+s[f+1]*p[d];for(p[f+2]=c[f]*p[f]-c[f+1]*p[f+1],p[f+3]=c[f]*p[f+1]+c[f+1]*p[f],d=f;d>0;d-=2)p[d]+=c[f]*p[d-2]-c[f+1]*p[d-1],p[d+1]+=c[f]*p[d-1]+c[f+1]*p[d-2]}for(f=0;f<i;++f)d=f<<1,e[f]=u[d]/h,t[f+1]=p[d+2]}(n,i,t);const s=Float64Array.of(0,i[1]-n[1]*i[0],i[2]-n[2]*i[0],i[3]-n[3]*i[0],-n[4]*i[0]),r=1+n[1]+n[2]+n[3]+n[4];return{sigma:t,negative:e,a:n,b_causal:i,b_anticausal:s,sum_causal:(i[0]+i[1]+i[2]+i[3])/r,sum_anticausal:(s[1]+s[2]+s[3]+s[4])/r}}function Qt(t,e,n,i=1,s=new Float64Array(n),r=new Float64Array(n),o=new Float64Array(5),a=s,l=Kt){const c=2*i,h=3*i,u=4*i,p=i*n;let d,f;for(l(s,e,n,i,t.b_causal,3,t.a,4,t.sum_causal,o,t.sigma),f=4,d=u;f<n;++f,d+=i)s[f]=t.b_causal[0]*e[d]+t.b_causal[1]*e[d-i]+t.b_causal[2]*e[d-c]+t.b_causal[3]*e[d-h]-t.a[1]*s[f-1]-t.a[2]*s[f-2]-t.a[3]*s[f-3]-t.a[4]*s[f-4];for(l(r,e,n,-i,t.b_anticausal,4,t.a,4,t.sum_anticausal,o,t.sigma),f=4,d=p-5*i;f<n;++f,d-=i)r[f]=t.b_anticausal[1]*e[d+i]+t.b_anticausal[2]*e[d+c]+t.b_anticausal[3]*e[d+h]+t.b_anticausal[4]*e[d+u]-t.a[1]*r[f-1]-t.a[2]*r[f-2]-t.a[3]*r[f-3]-t.a[4]*r[f-4];if(t.negative)for(f=0,d=0;f<n;++f,d+=i)a[d]=s[f]+r[n-f-1];else for(f=0,d=0;f<n;++f,d+=i)a[d]=Math.max(0,s[f]+r[n-f-1]);return a}function Kt(t,e,n,i,s,r,o,a,l,c,h,u=.5){const p=Math.abs(i)*n,d=i<0?p+i:0;let f,y,g;for(y=0;y<=a;++y)for(c[y]=y<=r?s[y]:0,g=1;g<=a&&g<=y;++g)c[y]-=o[g]*c[y-g];for(g=0;g<a;++g)for(t[g]=0,y=1;y<=g;++y)f=d+i*y,f>=0&&f<p&&(t[g]+=c[g-y]*e[f]);const m=e[d],x=Math.ceil(10*h);for(y=0;y<x;++y){for(g=0;g<a;++g)t[g]+=c[g]*m;if((l-=Math.abs(c[0]))<=u)break;for(c[a]=y+a<=r?s[y+a]:0,g=1;g<=a;++g)c[a]-=o[g]*c[a-g];for(g=0;g<a;++g)c[g]=c[g+1]}}const Jt="density";class te extends Nt{constructor(t,e,n){const{bandwidth:i=0,interpolate:s="none",pixelSize:r=1,pad:o=1,width:a,height:l,...c}=n,h=function(t){const e={};for(const n in t)"density"===t[n]&&(delete t[n],e[n]=!0);return e}(c);super(t,e,c,Bt),this.densityMap=h,this.bandwidth=Vt(i,(t=>(this.bandwidth=t,this.grids?this.convolve().update():null))),this.interpolate=Vt(s,(t=>(this.interpolate=t,this.requestUpdate()))),this.pixelSize=Vt(r,(t=>(this.pixelSize=t,this.requestUpdate()))),this.pad=Vt(o,(t=>(this.pad=t,this.requestUpdate()))),this.width=Vt(a,(t=>(this.width=t,this.requestUpdate()))),this.height=Vt(l,(t=>(this.height=t,this.requestUpdate())))}setPlot(t,e){const n=()=>{this.hasFieldInfo()&&this.requestUpdate()};t.addAttributeListener("xDomain",n),t.addAttributeListener("yDomain",n),super.setPlot(t,e)}get filterIndexable(){const t=this.plot.getAttribute("xDomain"),e=this.plot.getAttribute("yDomain");return t&&e&&!t[pt]&&!e[pt]}query(t=[]){const{interpolate:e,pad:n,channels:i,densityMap:s,source:r}=this,[o,a]=this.extentX=jt(this,t),[l,c]=this.extentY=Ct(this,t),[h,u]=this.bins=this.binDimensions(),[p,d]=qt(this,"x",h,[o,a],n),[f,y]=qt(this,"y",u,[l,c],n),g=n?[S(d,[+o,+a]),S(y,[+l,+c])]:[k(+o,d),F(d,+a),k(+l,y),F(y,+c)],x=m.from(r.table).where(t.concat(g)),b=this.groupby=[],E={};for(const t of i)if(Object.hasOwn(t,"field")){const{as:e,channel:n,field:i}=t;i.aggregate?(E[n]=i,s[n]=!0):"weight"===n?E[Jt]=T(i):"x"!==n&&"y"!==n&&(x.select({[e]:i}),b.push(e))}const v=this.aggr=Object.keys(E);if(E.density&&v.length>1)throw new Error("Weight option can not be used with custom aggregates.");if(v.length||(v.push(Jt),E.density=M()),"linear"===e){if(v.length>1)throw new Error("Linear binning not applicable to multiple aggregates.");if(!E.density)throw new Error("Linear binning not applicable to custom aggregates.");return function(t,e,n,i,s,r){const o=i?.column?`* ${i.column}`:"",a=(i,s)=>t.clone().select({xp:e,yp:n,i:i,w:s}),l=a(A`FLOOR(xp)::INTEGER + FLOOR(yp)::INTEGER * ${s}`,A`(FLOOR(xp)::INTEGER + 1 - xp) * (FLOOR(yp)::INTEGER + 1 - yp)${o}`),c=a(A`FLOOR(xp)::INTEGER + (FLOOR(yp)::INTEGER + 1) * ${s}`,A`(FLOOR(xp)::INTEGER + 1 - xp) * (yp - FLOOR(yp)::INTEGER)${o}`),h=a(A`FLOOR(xp)::INTEGER + 1 + FLOOR(yp)::INTEGER * ${s}`,A`(xp - FLOOR(xp)::INTEGER) * (FLOOR(yp)::INTEGER + 1 - yp)${o}`),u=a(A`FLOOR(xp)::INTEGER + 1 + (FLOOR(yp)::INTEGER + 1) * ${s}`,A`(xp - FLOOR(xp)::INTEGER) * (yp - FLOOR(yp)::INTEGER)${o}`);return m.from(m.unionAll(l,c,h,u)).select({index:"i",density:T("w")},r).groupby("index",r).having(N("density",0))}(x,p,f,E[Jt],h,b)}return function(t,e,n,i,s,r){return t.select({index:A`FLOOR(${e})::INTEGER + FLOOR(${n})::INTEGER * ${s}`,...i}).groupby("index",r)}(x,p,f,E,h,b)}binDimensions(){const{plot:t,pixelSize:e,width:n,height:i}=this;return[n??Math.round(t.innerWidth()/e),i??Math.round(t.innerHeight()/e)]}queryResult(t){const[e,n]=this.bins,s=function(t="none"){if("function"==typeof t)return t;switch(t.toLowerCase()){case"none":case"linear":return;case"nearest":return y;case"barycentric":return f();case"random-walk":return d()}throw new Error(`invalid interpolate: ${t}`)}(this.interpolate),{columns:r}=i(t);return this.grids0=function(t,e,n,i,s,r,o){const a=n.length,l=t*e,c=s.map((t=>i[t])),h={},u=[],p=new Int32Array(a);if(r?.length){const t=r.map((t=>i[t])),e={};for(let n=0;n<a;++n){const i=t.map((t=>t[n]));p[n]=e[i]??=u.push(i)-1}for(let t=0;t<r.length;++t)h[r[t]]=u.map((e=>e[t]))}else u.push([]);if(o){const i=n.map((e=>e%t)),r=n.map((e=>Math.floor(e/t))),l=u.map((()=>[]));for(let t=0;t<a;++t)l[p[t]].push(t);s.forEach(((n,s)=>{const a=c[s];h[n]=u.map(((n,s)=>o(l[s],t,e,i,r,a)))}))}else s.forEach(((t,e)=>{const i=c[e],s=h[t]=u.map((()=>Xt(l,i)));for(let t=0;t<a;++t)s[p[t]][n[t]]=i[t]}));return{numRows:u.length,columns:h}}(e,n,r.index,r,this.aggr,this.groupby,s),this.convolve()}convolve(){const{aggr:t,bandwidth:e,bins:n,grids0:i,plot:s}=this;if(this.grids=i,e>0){const r=1===t.length?t[0]:t.includes(Jt)?Jt:null;if(!r)return console.warn("No compatible grid found for smoothing."),this;const o=i.columns[r],a=s.innerWidth(),l=s.innerHeight(),[c,h]=n,u=o.some((t=>t.some((t=>t<0)))),p=Zt(e*(c-1)/a,u),d=Zt(e*(h-1)/l,u);this.grids={numRows:i.numRows,columns:{...i.columns,[r]:o.map((t=>function(t,e,n,[i,s]){const r=new Float64Array(Math.max(i,s)),o=new Float64Array(Math.max(i,s)),a=new Float64Array(5),l=new Float64Array(n.length);for(let e=0,c=0;e<s;++e,c+=i){const e=l.subarray(c);Qt(t,n.subarray(c),i,1,r,o,a,e)}for(let t=0;t<i;++t){const n=l.subarray(t);Qt(e,n,s,i,r,o,a,n)}return l}(p,d,t,n)))}}}return this}}class ee extends te{constructor(t,e){const{thresholds:n=10,...i}=e;super("geo",t,{bandwidth:20,interpolate:"linear",pixelSize:2,...i}),this.thresholds=Vt(n,(t=>(this.thresholds=t,this.grids?this.contours().update():null)))}convolve(){return super.convolve().contours()}contours(){const{bins:t,densityMap:e,grids:n,thresholds:i,plot:s}=this,{numRows:r,columns:o}=n;let a,l=i;if(Array.isArray(l))a=l;else{const[,t]=Yt(o.density);a=Array.from({length:l-1},((e,n)=>t*(n+1)/l))}(e.fill||e.stroke)&&"log"!==this.plot.getAttribute("colorScale")&&this.plot.setAttribute("colorZero",!0);const[c,h]=t,[u,p]=s.getAttribute("xDomain"),[d,f]=s.getAttribute("yDomain"),y=(p-u)/c,g=(f-d)/h,m=+u,x=+d,b=t=>m+t*y,E=t=>x+t*g,v=K().size(t),A=this.contourData=Array(r*a.length),{density:w,...R}=o,O=Object.entries(R);for(let t=0,e=0;t<r;++t){const n=w[t],i=O.reduce(((e,[n,i])=>(e[n]=i[t],e)),{});for(let t=0;t<a.length;++t,++e)A[e]=Object.assign(ne(v.contour(n,a[t]),b,E),i)}return this}plotSpecs(){const{type:t,channels:e,densityMap:n,contourData:i}=this,s={};for(const t of e){const{channel:e}=t;"x"!==e&&"y"!==e&&(s[e]=$t(t))}for(const t in n)n[t]&&(s[t]=$t({channel:t,as:"value"}));return[{type:t,data:i,options:s}]}}function ne(t,e,n){function i(t){t.forEach(s)}function s(t){t[0]=e(t[0]),t[1]=n(t[1])}return t.coordinates.forEach((function(t){t.forEach(i)})),t}function ie(t){return Array.from({length:t},((t,e)=>e))}function se(t,e){const n=e.reduce(((t,e,n)=>(t[e]=n,t)),{}),i=ie(t.length);return i.sort(((e,i)=>n[t[e]]-n[t[i]])),i}function re(t,e){if("undefined"!=typeof document){const n=document.createElement("canvas");return n.setAttribute("width",t),n.setAttribute("height",e),n}throw new Error("Can not create a canvas instance.")}class oe extends te{constructor(t,e){super("image",t,e),this.image=null}setPlot(t,e){t.addAttributeListener("schemeColor",(()=>{this.hasFieldInfo()&&this.rasterize()})),super.setPlot(t,e)}convolve(){return super.convolve().rasterize()}rasterize(){const{bins:t,grids:e}=this,[n,i]=t,{numRows:s,columns:r}=e,{canvas:o,ctx:a,img:l}=function(t,e,n){if(!t.image||t.image.w!==e||t.image.h!==n){const i=re(e,n),s=i.getContext("2d",{willReadFrequently:!0}),r=s.getImageData(0,0,e,n);t.image={canvas:i,ctx:s,img:r,w:e,h:n}}return t.image}(this,n,i),{alpha:c,alphaProp:h,color:u,colorProp:p}=le(this),d=r[h]??[],f=r[p]??[],y=s>1&&p&&this.groupby?.includes(p)?se(f,this.plot.getAttribute("colorDomain")):ie(s);return this.data={numRows:s,columns:{src:Array.from({length:s},((t,e)=>(u?.(l.data,n,i,f[y[e]]),c?.(l.data,n,i,d[y[e]]),a.putImageData(l,0,0),o.toDataURL())))}},this}plotSpecs(){const{type:t,plot:e,data:{numRows:n,columns:i}}=this;return[{type:t,data:{length:n},options:{src:i.src,width:e.innerWidth(),height:e.innerHeight(),preserveAspectRatio:"none",imageRendering:this.channel("imageRendering")?.value,frameAnchor:"middle"}}]}}class ae extends oe{constructor(t,e){super(t,{bandwidth:20,interpolate:"linear",pixelSize:2,...e})}}function le(t){const{aggr:e,densityMap:n,groupby:i,plot:s}=t,r=e.includes(Jt),o=e.includes("fillOpacity"),a=t.channel("fill"),l=t.channel("fillOpacity");if(e.length>2||r&&o)throw new Error("Invalid raster encodings. Try dropping an aggregate?");if(i.includes(l?.as))throw new Error("Raster fillOpacity must be an aggregate or constant.");const c=n.fill||e.includes("fill")?"grid":i.includes(a?.as)?"group":Rt(a?.value)?a.value:r&&s.getAttribute("colorScheme")?"grid":void 0,h=n.fillOpacity||e.includes("fillOpacity")?"grid":"number"==typeof l?.value?l.value:r&&"grid"!==c?"grid":void 0;if("grid"!==c&&"grid"!==h)throw new Error("Raster mark missing density values.");const u=a?.as??("grid"===c?Jt:null),p=l?.as??("grid"===h?Jt:null),d="grid"!==c&&"group"!==c?function(t={}){const{r:e=0,g:n=0,b:i=0,opacity:s=1}="string"==typeof t?J(t):t,r=new Uint8ClampedArray([e,n,i,255*s|0]);return(t,e,n)=>{for(let i=0,s=0;i<n;++i)for(let n=0;n<e;++n,s+=4)t[s+0]=r[0],t[s+1]=r[1],t[s+2]=r[2],t[s+3]=r[3]}}(c):function(t,e){const{plot:n,grids:i}=t,s=i.columns[e],r=!s[0]?.map,o=r||Array.isArray(s[0]),a=n.getAttribute("colorDomain"),l=a===ut,c=a?.[pt],h=!l&&!c&&a||(r?s.slice().sort(Q):o?function(t){const e=new Z;return t.forEach((t=>{const n=t.length;for(let i=0;i<n;++i)e.add(t[i])})),Array.from(e).sort(Q)}(s):Yt(s));(l||c||!a)&&(l||(h[pt]=!0),n.setAttribute("colorDomain",h));const u=g({color:{type:n.getAttribute("colorScale"),domain:h,range:n.getAttribute("colorRange"),clamp:n.getAttribute("colorClamp"),n:n.getAttribute("colorN"),nice:n.getAttribute("colorNice"),reverse:n.getAttribute("colorReverse"),scheme:n.getAttribute("colorScheme"),interpolate:n.getAttribute("colorInterpolate"),pivot:n.getAttribute("colorPivot"),symmetric:n.getAttribute("colorSymmetric"),zero:n.getAttribute("colorZero"),base:n.getAttribute("colorBase"),exponent:n.getAttribute("colorExponent"),constant:n.getAttribute("colorConstant")}});if(o)return function(t){const{domain:e,range:n}=t,i=Object.create(null),s=new Uint8ClampedArray(4*e.length),r=e.length-1,o=n.length;for(let t=0;t<=r;++t){const r=n[t%o],{r:a,g:l,b:c,opacity:h=1}="string"==typeof r?J(r):r,u=t<<2;s[u+0]=a,s[u+1]=l,s[u+2]=c,s[u+3]=255*h|0,i[e[t]]=u}return(t,e,n,r)=>{if(r.map)for(let o=0,a=0;o<n;++o)for(let l=0,c=(n-o-1)*e;l<e;++l,a+=4){const e=i[r[l+c]];t[a+0]=s[e+0],t[a+1]=s[e+1],t[a+2]=s[e+2],t[a+3]=s[e+3]}else{const o=i[r];for(let i=0,r=0;i<n;++i)for(let n=0;n<e;++n,r+=4)t[r+0]=s[o+0],t[r+1]=s[o+1],t[r+2]=s[o+2],t[r+3]=s[o+3]}}}(u);return function(t,e,n){const{interpolate:i}=e,s=new Uint8ClampedArray(4*t),r=t-1;for(let t=0;t<=r;++t){const e=i(t/r),{r:n,g:o,b:a,opacity:l=1}="string"==typeof e?J(e):e,c=t<<2;s[c+0]=n,s[c+1]=o,s[c+2]=a,s[c+3]=255*l|0}return(t,e,i,o)=>{for(let a=0,l=0;a<i;++a)for(let c=0,h=(i-a-1)*e;c<e;++c,l+=4){const e=r*n(o[c+h])<<2;t[l+0]=s[e+0],t[l+1]=s[e+1],t[l+2]=s[e+2],t[l+3]=s[e+3]}}}(1024,u,g({x:{type:ce(u.type),domain:u.domain,reverse:u.reverse,range:[0,1],clamp:u.clamp,base:u.base,exponent:u.exponent,constant:u.constant}}).apply)}(t,u),f="grid"!==h?function(t=1){const e=255*t|0;return(t,n,i)=>{for(let s=0,r=0;s<i;++s)for(let i=0;i<n;++i,r+=4)t[r+3]=e}}(h):function(t,e){const{plot:n,grids:i}=t,s=n.getAttribute("opacityDomain"),r=s===ut,o=s?.[pt],a=!r&&!o&&s||Yt(i.columns[e]);(r||o||!s)&&(r||(a[pt]=!0),n.setAttribute("opacityDomain",a));const l=g({opacity:{type:n.getAttribute("opacityScale"),domain:a,clamp:n.getAttribute("opacityClamp"),nice:n.getAttribute("opacityNice"),reverse:n.getAttribute("opacityReverse"),zero:n.getAttribute("opacityZero"),base:n.getAttribute("opacityBase"),exponent:n.getAttribute("opacityExponent"),constant:n.getAttribute("opacityConstant")}});return function(t){const{apply:e}=t;return(t,n,i,s)=>{for(let r=0,o=0;r<i;++r)for(let a=0,l=(i-r-1)*n;a<n;++a,o+=4)t[o+3]=255*e(s[a+l])|0}}(l)}(t,p);return{alphaProp:p,colorProp:u,alpha:f,color:d}}function ce(t){return t.endsWith("symlog")?"symlog":t.endsWith("log")?"log":t.endsWith("pow")?"pow":t.endsWith("sqrt")?"sqrt":"diverging"===t?"linear":t}class he extends oe{constructor(t,e){const{normalize:n=!0,...i}=e;super(t,i),this.normalize=Vt(n,(t=>(this.normalize=t,this.requestUpdate())))}query(t=[]){const{channels:e,normalize:n,source:i,pad:s}=this,[r,o]=this.bins=this.binDimensions(),[a]=qt(this,"x",r,jt(this,t),s),[l]=qt(this,"y",o,Ct(this,t),s),c=m.from(i.table).where(function(t,e){if(Array.isArray(e)&&!e.length)return e;const{column:n}=t.channelField("x"),{column:i}=t.channelField("y"),s=t=>{const e=`${t.field}`;return"BETWEEN"!==t.op||e!==n&&e!==i},r=t=>"AND"===t.op?$(t.children.filter((t=>s(t)))):t;return Array.isArray(e)?e.filter((t=>s(t))).map((t=>r(t))):r(e)}(this,t));this.aggr=["density"];const h=this.groupby=[],u=[];for(const t of e)if(Object.hasOwn(t,"field")){const{channel:e,field:n}=t;"z"===e?(c.select({[e]:n}),u.push("z")):"x"!==e&&"y"!==e&&(c.select({[e]:n}),h.push(e))}return function(t,e,n,i,s,r,o=[],a=!0){t.select({x:A`FLOOR(${e})::INTEGER`,y:A`FLOOR(${n})::INTEGER`});const l=o.concat(i),c=l.length?`PARTITION BY ${l.join(", ")} `:"",h=m.from(t).select(l,{x0:"x",y0:"y",dx:A`(lead(x) OVER sw - x)`,dy:A`(lead(y) OVER sw - y)`}).window({sw:A`${c}ORDER BY x ASC`}).qualify($(A`(x0 < ${s} OR x0 + dx < ${s})`,A`(y0 < ${r} OR y0 + dy < ${r})`,A`(x0 > 0 OR x0 + dx > 0)`,A`(y0 > 0 OR y0 + dy > 0)`)),u=m.select({x:A`GREATEST(MAX(ABS(dx)), MAX(ABS(dy)))`}).from("pairs"),p=m.select({i:A`UNNEST(range((${u})))::INTEGER`}),d=m.unionAll(m.select(l,{x:A`x0 + i`,y:A`y0 + ROUND(i * dy / dx::FLOAT)::INTEGER`}).from("pairs","indices").where(A`ABS(dy) <= ABS(dx) AND i < ABS(dx)`),m.select(l,{x:A`x0 + ROUND(SIGN(dy) * i * dx / dy::FLOAT)::INTEGER`,y:A`y0 + SIGN(dy) * i`}).from("pairs","indices").where(A`ABS(dy) > ABS(dx) AND i < ABS(dy)`),m.select(l,{x:"x0",y:"y0"}).from("pairs").where(_("dx"))),f=["x"].concat(l).join(", "),y=m.from("raster").select(l,"x","y",a?{w:A`1.0 / COUNT(*) OVER (PARTITION BY ${f})`}:null).where($(S("x",[0,s],!0),S("y",[0,r],!0)));return m.with({pairs:h,indices:p,raster:d,points:y}).from("points").select(o,{index:A`x + y * ${s}::INTEGER`,density:a?T("w"):M()}).groupby("index",o)}(c,a,l,u,r,o,h,n)}}class ue extends Nt{constructor(t,e,n){const{bins:i=1024,bandwidth:s=20,...r}=n,o=t.endsWith("X")?"y":"x";super(t,e,r,"x"===o?zt:Gt),this.dim=o,this.bins=Vt(i,(t=>(this.bins=t,this.requestUpdate()))),this.bandwidth=Vt(s,(t=>(this.bandwidth=t,this.grid?this.convolve().update():null)))}get filterIndexable(){const t="x"===this.dim?"xDomain":"yDomain",e=this.plot.getAttribute(t);return e&&!e[pt]}query(t=[]){if(this.hasOwnData())throw new Error("Density1DMark requires a data source");const{bins:e,channels:n,dim:i,source:{table:s}}=this,r=this.extent=("x"===i?jt:Ct)(this,t),[o,a]=qt(this,i,e,r);return function(t,e,n){const i=n?`* ${n}`:"",s=t.clone().select({p:e,i:A`FLOOR(p)::INTEGER`,w:A`(FLOOR(p) + 1 - p)${i}`}),r=t.clone().select({p:e,i:A`FLOOR(p)::INTEGER + 1`,w:A`(p - FLOOR(p))${i}`});return m.from(m.unionAll(s,r)).select({index:"i",density:T("w")}).groupby("index").having(I("density",0))}(_t(n,s,[i]).where(t.concat(S(a,r))),o,this.channelField("weight")?"weight":null)}queryResult(t){const{columns:{index:e,density:n}}=i(t);return this.grid=function(t,e,n){const i=Xt(t,n),s=n.length;for(let t=0;t<s;++t)i[e[t]]=n[t];return i}(this.bins,e,n),this.convolve()}convolve(){const{bins:t,bandwidth:e,dim:n,grid:i,plot:s,extent:[r,o]}=this,a=i.some((t=>t<0)),l=Qt(Zt(e*(t-1)/("x"===n?s.innerWidth():s.innerHeight()),a),i,t),c="x"===n?"y":"x",h=this.channelField(n).as,u=+r,p=(o-u)/(t-1),d=1/p,f=new Float64Array(t),y=new Float64Array(t);for(let e=0;e<t;++e)f[e]=u+e*p,y[e]=l[e]*d;return this.data={numRows:t,columns:{[h]:f,[c]:y}},this}plotSpecs(){const{type:t,data:{numRows:e,columns:n},channels:i,dim:s}=this,r="x"===s?{y:n.y}:{x:n.x};for(const t of i)r[t.channel]=$t(t,n);return[{type:t,data:{length:e},options:r}]}}class pe extends te{constructor(t,e){const{type:n="dot",...i}=e;super(n,t,{bandwidth:20,interpolate:"linear",pad:0,pixelSize:2,...i})}convolve(){super.convolve();const{bins:t,pad:e,extentX:n,extentY:i}=this,[s,r]=t,o=Dt(this,"x"),a=Dt(this,"y"),[l,c]=n.map((t=>o.apply(t))),[h,u]=i.map((t=>a.apply(t))),p=(c-l)/(s-e),d=(u-h)/(r-e),f=e?0:.5;return this.data=function(t,e,n,i,s,r,o,a,l){const c=1/(s*r),[h,u]=e,p=h*u,d=p*t.numRows,f=new Float64Array(d),y=new Float64Array(d),g=new Float64Array(d),m={x:f,y:y,density:g},{density:x,...b}=t.columns;for(const t in b)m[t]=new b[t].constructor(d);let E=0;for(let e=0;e<t.numRows;++e){for(const t in b)m[t].fill(b[t][e],E,E+p);const t=x[e];for(let e=0,p=0;p<u;++p)for(let u=0;u<h;++u,++E,++e)f[E]=o(n+(u+l)*s),y[E]=a(i+(p+l)*r),g[E]=t[e]*c}return{numRows:d,columns:m}}(this.grids,t,l,h,p,d,o.invert,a.invert,f),this}plotSpecs(){const{type:t,channels:e,densityMap:n,data:{numRows:i,columns:s}}=this,r={};for(const t of e){const{channel:e}=t;r[e]="x"===e||"y"===e?s[e]:$t(t,s)}for(const t in n)n[t]&&(r[t]=s.density);return[{type:t,data:{length:i},options:r}]}}function de(t,e,n){var i=0===t||1===t?0:Math.exp(ye(e+n)-ye(e)-ye(n)+e*Math.log(t)+n*Math.log(1-t));return t<0||t>1?0:t<(e+1)/(e+n+2)?i*fe(t,e,n)/e:1-i*fe(1-t,n,e)/n}function fe(t,e,n){var i,s,r,o,a=1e-30,l=1,c=e+n,h=e+1,u=e-1,p=1,d=1-c*t/h;for(Math.abs(d)<a&&(d=a),o=d=1/d;l<=100&&(d=1+(s=l*(n-l)*t/((u+(i=2*l))*(e+i)))*d,Math.abs(d)<a&&(d=a),p=1+s/p,Math.abs(p)<a&&(p=a),o*=(d=1/d)*p,d=1+(s=-(e+l)*(c+l)*t/((e+i)*(h+i)))*d,Math.abs(d)<a&&(d=a),p=1+s/p,Math.abs(p)<a&&(p=a),o*=r=(d=1/d)*p,!(Math.abs(r-1)<3e-7));l++);return o}function ye(t){var e,n,i,s=0,r=[76.18009172947146,-86.5053203294167,24.01409824083091,-1.231739572450155,.001208650973866179,-5395239384953e-18],o=1.000000000190015;for(i=(n=e=t)+5.5,i-=(e+.5)*Math.log(i);s<6;s++)o+=r[s]/++n;return Math.log(2.506628274631*o/e)-i}function ge(t,e){var n=function(t,e,n){var i,s,r,o,a,l,c,h,u,p,d=e-1,f=n-1,y=0;if(t<=0)return 0;if(t>=1)return 1;for(e>=1&&n>=1?(r=t<.5?t:1-t,l=(2.30753+.27061*(o=Math.sqrt(-2*Math.log(r))))/(1+o*(.99229+.04481*o))-o,t<.5&&(l=-l),c=(l*l-3)/6,h=2/(1/(2*e-1)+1/(2*n-1)),u=l*Math.sqrt(c+h)/h-(1/(2*n-1)-1/(2*e-1))*(c+5/6-2/(3*h)),l=e/(e+n*Math.exp(2*u))):(i=Math.log(e/(e+n)),s=Math.log(n/(e+n)),l=t<(o=Math.exp(e*i)/e)/(u=o+(a=Math.exp(n*s)/n))?Math.pow(e*u*t,1/e):1-Math.pow(n*u*(1-t),1/n)),p=-ye(e)-ye(n)+ye(e+n);y<10;y++){if(0===l||1===l)return l;if((l-=o=(a=(de(l,e,n)-t)/(o=Math.exp(d*Math.log(l)+f*Math.log(1-l)+p)))/(1-.5*Math.min(1,a*(d/l-f/(1-l)))))<=0&&(l=.5*(l+o)),l>=1&&(l=.5*(l+o+1)),Math.abs(o)<1e-8*l&&y>0)break}return l}(2*Math.min(t,1-t),.5*e,.5);return n=Math.sqrt(e*(1-n)/n),t>.5?n:-n}class me extends Nt{constructor(t,e,n){const i=t.endsWith("X")?"y":"x",{ci:s=.95,...r}=n;super(t,e,r),this.dim=i,this.field=this.channelField(i).field,this.channels=this.channels.filter((t=>t.channel!==i)),this.ci=Vt(s,(t=>(this.ci=t,this.update())))}query(t=[]){const{channels:e,field:n,source:{table:i}}=this;return _t(e.concat([{field:D(n),as:"__avg__"},{field:M(n),as:"__n__"},{field:q(n),as:"__sd__"}]),i).where(t)}queryResult(t){return this.data=i(t),this}plotSpecs(){const{type:t,dim:e,detail:n,data:i,ci:s,channels:r}=this,o=Math.SQRT2*function(t){let e,n=-Math.log((1-t)*(1+t));return n<6.25?(n-=3.125,e=-364441206401782e-35,e=e*n-16850591381820166e-35,e=128584807152564e-32+e*n,e=11157877678025181e-33+e*n,e=e*n-1333171662854621e-31,e=20972767875968562e-33+e*n,e=6637638134358324e-30+e*n,e=e*n-4054566272975207e-29,e=e*n-8151934197605472e-29,e=26335093153082323e-28+e*n,e=e*n-12975133253453532e-27,e=e*n-5415412054294628e-26,e=1.0512122733215323e-9+e*n,e=e*n-4.112633980346984e-9,e=e*n-2.9070369957882005e-8,e=4.2347877827932404e-7+e*n,e=e*n-13654692000834679e-22,e=e*n-13882523362786469e-21,e=.00018673420803405714+e*n,e=e*n-.000740702534166267,e=e*n-.006033670871430149,e=.24015818242558962+e*n,e=1.6536545626831027+e*n):n<16?(n=Math.sqrt(n)-3.25,e=2.2137376921775787e-9,e=9.075656193888539e-8+e*n,e=e*n-2.7517406297064545e-7,e=1.8239629214389228e-8+e*n,e=15027403968909828e-22+e*n,e=e*n-4013867526981546e-21,e=29234449089955446e-22+e*n,e=12475304481671779e-21+e*n,e=e*n-47318229009055734e-21,e=6828485145957318e-20+e*n,e=24031110387097894e-21+e*n,e=e*n-.0003550375203628475,e=.0009532893797373805+e*n,e=e*n-.0016882755560235047,e=.002491442096107851+e*n,e=e*n-.003751208507569241,e=.005370914553590064+e*n,e=1.0052589676941592+e*n,e=3.0838856104922208+e*n):Number.isFinite(n)?(n=Math.sqrt(n)-5,e=-27109920616438573e-27,e=e*n-2.555641816996525e-10,e=1.5076572693500548e-9+e*n,e=e*n-3.789465440126737e-9,e=7.61570120807834e-9+e*n,e=e*n-1.496002662714924e-8,e=2.914795345090108e-8+e*n,e=e*n-6.771199775845234e-8,e=2.2900482228026655e-7+e*n,e=e*n-9.9298272942317e-7,e=4526062597223154e-21+e*n,e=e*n-1968177810553167e-20,e=7599527703001776e-20+e*n,e=e*n-.00021503011930044477,e=e*n-.00013871931833623122,e=1.0103004648645344+e*n,e=4.849906401408584+e*n):e=1/0,e*t}(s),{columns:{__avg__:a,__sd__:l,__n__:c}}=i;return It(t,n,r,i,{[`${e}1`]:a.map(((t,e)=>t-o*l[e]/Math.sqrt(c[e]))),[`${e}2`]:a.map(((t,e)=>t+o*l[e]/Math.sqrt(c[e])))})}}class xe extends Nt{constructor(t,e={},n){Mt(t)||e?.geometry||(e.geometry=z("geom")),super("geo",t,e,n)}queryResult(t){super.queryResult(t);const e=this.channelField("geometry")?.as;if(e){const{columns:t}=this.data;"string"==typeof t[e][0]&&(t[e]=t[e].map((t=>JSON.parse(t))))}return this}}class be extends Nt{constructor(t,e){const{type:n="hexagon",binWidth:i=20,...s}=e;super(n,t,{r:i/2,clip:!0,...s},Bt),this.binWidth=Vt(i,(t=>(this.binWidth=t,this.requestUpdate())))}get filterIndexable(){const t=this.plot.getAttribute("xDomain"),e=this.plot.getAttribute("yDomain");return t&&e&&!t[pt]&&!e[pt]}query(t=[]){if(this.hasOwnData())return null;const{plot:e,binWidth:n,channels:i,source:s}=this;let r,o;const a=new Set,l={};for(const t of i)if("orderby"===t.channel);else if("x"===t.channel)r=t;else if("y"===t.channel)o=t;else if(Object.hasOwn(t,"field")){const{as:e,field:n}=t;l[e]=n,n.aggregate||a.add(e)}const[c,h]=jt(this,t),[u,p]=Ct(this,t),d=.5-e.getAttribute("marginLeft"),f=0-e.getAttribute("marginTop"),y=`${n}::DOUBLE`,g=n*(1.5/Math.sqrt(3))+"::DOUBLE",x=e.innerWidth()/(h-c)+"::DOUBLE",b=e.innerHeight()/(p-u)+"::DOUBLE";return m.select({[r.as]:A`${c}::DOUBLE + ((_x + 0.5 * (_y & 1)) * ${y} + ${d})::DOUBLE / ${x}`,[o.as]:A`${p}::DOUBLE - (_y * ${g} + ${f})::DOUBLE / ${b}`,...l}).groupby("_x","_y",...a).from(m.select({_py:A`(${b} * (${p}::DOUBLE - ${o.field}) - ${f}) / ${g}`,_pj:A`ROUND(_py)::INTEGER`,_px:A`(${x} * (${r.field} - ${c}::DOUBLE) - ${d}) / ${y} - 0.5 * (_pj & 1)`,_pi:A`ROUND(_px)::INTEGER`,_tt:A`ABS(_py-_pj) * 3 > 1 AND (_px-_pi)**2 + (_py-_pj)**2 > (_px - _pi - 0.5 * CASE WHEN _px < _pi THEN -1 ELSE 1 END)**2 + (_py - _pj - CASE WHEN _py < _pj THEN -1 ELSE 1 END)**2`,_x:A`CASE WHEN _tt THEN (_pi + (CASE WHEN _px < _pi THEN -0.5 ELSE 0.5 END) + (CASE WHEN _pj & 1 <> 0 THEN 0.5 ELSE -0.5 END))::INTEGER ELSE _pi END`,_y:A`CASE WHEN _tt THEN (_pj + CASE WHEN _py < _pj THEN -1 ELSE 1 END)::INTEGER ELSE _pj END`},"*").from(s.table).where(G(r.field),G(o.field),t))}}class Ee extends te{constructor(t,e){const{origin:n=[0,0],dim:i="xy",...s}=e;super("image",t,s),this.image=null,this.origin=n,this.tileX=i.toLowerCase().includes("x"),this.tileY=i.toLowerCase().includes("y")}setPlot(t,e){t.addAttributeListener("schemeColor",(()=>{this.hasFieldInfo()&&this.rasterize()})),super.setPlot(t,e)}requestQuery(){return this.requestTiles()}query(t=[]){return this._filter=t,null}tileQuery(t){const{interpolate:e,pad:n,channels:i,densityMap:s,source:r}=this,[[o,a],[l,c]]=t,[h,u]=this.bins,[p,d]=qt(this,"x",h,[o,a],n),[f,y]=qt(this,"y",u,[l,c],n),g=n?[S(d,[+o,+a]),S(y,[+l,+c])]:[k(+o,d),F(d,+a),k(+l,y),F(y,+c)],x=m.from(r.table).where(g),b=this.groupby=[],E={};for(const t of i)if(Object.hasOwn(t,"field")){const{as:e,channel:n,field:i}=t;i.aggregate?(E[n]=i,s[n]=!0):"weight"===n?E.density=T(i):"x"!==n&&"y"!==n&&(x.select({[e]:i}),b.push(e))}const v=this.aggr=Object.keys(E);if(E.density&&v.length>1)throw new Error("Weight option can not be used with custom aggregates.");if(v.length||(v.push("density"),E.density=M()),"linear"===e){if(v.length>1)throw new Error("Linear binning not applicable to multiple aggregates.");if(!E.density)throw new Error("Linear binning not applicable to custom aggregates.");return function(t,e,n,i,s,r){const o=i.column?`* ${i.column}`:"",a=(i,s)=>t.clone().select({xp:e,yp:n,i:i,w:s}),l=a(A`FLOOR(xp)::INTEGER + FLOOR(yp)::INTEGER * ${s}`,A`(FLOOR(xp)::INTEGER + 1 - xp) * (FLOOR(yp)::INTEGER + 1 - yp)${o}`),c=a(A`FLOOR(xp)::INTEGER + (FLOOR(yp)::INTEGER + 1) * ${s}`,A`(FLOOR(xp)::INTEGER + 1 - xp) * (yp - FLOOR(yp)::INTEGER)${o}`),h=a(A`FLOOR(xp)::INTEGER + 1 + FLOOR(yp)::INTEGER * ${s}`,A`(xp - FLOOR(xp)::INTEGER) * (FLOOR(yp)::INTEGER + 1 - yp)${o}`),u=a(A`FLOOR(xp)::INTEGER + 1 + (FLOOR(yp)::INTEGER + 1) * ${s}`,A`(xp - FLOOR(xp)::INTEGER) * (yp - FLOOR(yp)::INTEGER)${o}`);return m.from(m.unionAll(l,c,h,u)).select({index:"i",density:T("w")},r).groupby("index",r).having(N("density",0))}(x,p,f,E.density,h,b)}return function(t,e,n,i,s,r){return t.select({index:A`FLOOR(${e})::INTEGER + FLOOR(${n})::INTEGER * ${s}`,...i}).groupby("index",r)}(x,p,f,E,h,b)}async requestTiles(){const t=r();this.prefetch&&t.cancel(this.prefetch);const{pad:e,tileX:n,tileY:i,origin:[s,o]}=this,[a,l]=this.bins=this.binDimensions(),[c,h]=jt(this,this._filter),[u,p]=Ct(this,this._filter),d=h-c,f=p-u,y=Math.floor((c-s)*(a-e)/d),g=Math.floor((u-o)*(l-e)/f),m=(t,e)=>[[s+t*d,s+(t+1)*d],[o+e*f,o+(e+1)*f]],x=Math.floor((c-s)/d),b=n?ve((h-s)/d):x,E=Math.floor((u-o)/f),v=i?ve((p-o)/f):E,A=[];for(let t=x;t<=b;++t)for(let e=E;e<=v;++e)A.push([t,e]);const w=A.map((([e,n])=>t.query(this.tileQuery(m(e,n))))),R=[];if(n)for(let t=E;t<=v;++t)R.push([b+1,t]),R.push([x-1,t]);if(i){const t=n?b+1:b;for(let e=n?x-1:x;e<=t;++e)R.push([e,v+1]),R.push([e,E-1])}this.prefetch=R.map((([e,n])=>t.prefetch(this.tileQuery(m(e,n)))));const O=function(t,e,n,i,s,r){const o=new Float64Array(t*e);return r.forEach(((r,a)=>{const[l,c]=s[a];!function(t,e,n,i,s,r){const o=i.numRows;if(0===o)return;const a=i.getChild("index").toArray(),l=i.getChild("density").toArray();for(let i=0;i<o;++i){const o=a[i],c=s+o%t,h=r+Math.floor(o/t);0<=c&&c<t&&0<=h&&h<e&&(n[c+h*t]=l[i])}}(t,e,o,r,l*t-n,c*e-i)})),o}(a,l,y,g,A,await Promise.all(w));this.grids0={numRows:O.length,columns:{density:[O]}},this.convolve().update()}convolve(){return super.convolve().rasterize()}rasterize(){const{bins:t,grids:e}=this,[n,i]=t,{numRows:s,columns:r}=e,{canvas:o,ctx:a,img:l}=function(t,e,n){if(!t.image||t.image.w!==e||t.image.h!==n){const i=re(e,n),s=i.getContext("2d",{willReadFrequently:!0}),r=s.getImageData(0,0,e,n);t.image={canvas:i,ctx:s,img:r,w:e,h:n}}return t.image}(this,n,i),{alpha:c,alphaProp:h,color:u,colorProp:p}=le(this),d=r[h]??[],f=r[p]??[],y=s>1&&p&&this.groupby?.includes(p)?se(f,this.plot.getAttribute("colorDomain")):ie(s);return this.data={numRows:s,columns:{src:Array.from({length:s},((t,e)=>(u?.(l.data,n,i,f[y[e]]),c?.(l.data,n,i,d[y[e]]),a.putImageData(l,0,0),o.toDataURL())))}},this}plotSpecs(){const{type:t,plot:e,data:{numRows:n,columns:i}}=this;return[{type:t,data:{length:n},options:{src:i.src,width:e.innerWidth(),height:e.innerHeight(),preserveAspectRatio:"none",imageRendering:this.channel("imageRendering")?.value,frameAnchor:"middle"}}]}}function ve(t){const e=Math.floor(t);return e===t?e-1:e}class Ae extends Nt{constructor(t,e){const{ci:n=.95,precision:i=4,...s}=e;super("line",t,s);const r=()=>this.modelFit?this.confidenceBand().update():null;this.ci=Vt(n,(t=>(this.ci=t,r()))),this.precision=Vt(i,(t=>(this.precision=t,r())))}query(t=[]){const e=this.channelField("x").as,n=this.channelField("y").as,i=Array.from(new Set(["stroke","z","fx","fy"].flatMap((t=>this.channelField(t)?.as||[]))));return m.from(super.query(t)).select({intercept:B(n,e),slope:P(n,e),n:j(n,e),ssy:C(n,e),ssx:W(n,e),xm:U(n,e),x0:H(w(e).where(G(n))),x1:H(O(e).where(G(n)))}).select(i).groupby(i)}queryResult(t){return this.modelFit=i(t),this.lineData=function(t){const{x0:e=[],x1:n=[],xm:i,intercept:s,slope:r,n:o,ssx:a,ssy:l,...c}=t.columns,h=(t,e)=>s[e]+t*r[e],u=we(e,n),p=we(e.map(h),n.map(h));for(const t in c)c[t]=we(c[t],c[t]);return{numRows:u.length,columns:{x:u,y:p,...c}}}(this.modelFit),this.confidenceBand()}confidenceBand(){const{ci:t,modelFit:e,precision:n,plot:i}=this,s=i.innerWidth();return this.areaData=t?function(t,e,n,i){const s=t.numRows,{x0:r,x1:o,xm:a,intercept:l,slope:c,n:h,ssx:u,ssy:p,...d}=t.columns,f=Object.keys(d),y={x:[],y1:[],y2:[]};f.forEach((t=>y[t]=[]));for(let t=0;t<s;++t){const s=n*(o[t]-r[t])/i,g=ge((1-e)/2,h[t]-2)*Math.sqrt(p[t]/(h[t]-2));tt(r[t],o[t]-s/2,s).concat(o[t]).forEach((e=>{const n=l[t]+e*c[t],i=g*Math.sqrt(1/h[t]+(e-a[t])**2/u[t]);y.x.push(e),y.y1.push(n-i),y.y2.push(n+i),f.forEach((e=>y[e].push(d[e][t])))}))}return{numRows:y.x.length,columns:y}}(e,t,n,s):null,this}plotSpecs(){const{lineData:t,areaData:e,channels:n,ci:i}=this,s=t.columns,r=i?e.columns:{},o={x:s.x,y:s.y},a={x:r.x,y1:r.y1,y2:r.y2,fillOpacity:.1};for(const t of n)switch(t.channel){case"x":case"y":case"fill":break;case"tip":a.tip=$t(t,r);break;case"stroke":o.stroke=$t(t,s),a.fill=$t(t,r);break;case"strokeOpacity":o.strokeOpacity=$t(t,s);break;case"fillOpacity":a.fillOpacity=$t(t,r);break;default:o[t.channel]=$t(t,s),a[t.channel]=$t(t,r)}return[...i?[{type:"areaY",data:{length:e.numRows},options:a}]:[],{type:"line",data:{length:t.numRows},options:o}]}}function we(t,e){if(t.concat)return t.concat(e);const n=new t.constructor(t.length+e.length);return n.set(t,0),n.set(e,t.length),n}function Re(t){const e=t.toLowerCase(),n=t.length;let i="";for(let s=0;s<n;++s)i+=(t[s]!==e[s]?"-":"")+e[s];return i}function Oe(t){const e={};for(const n in t)e[Re(n)]=t[n];return e}class Le{constructor(t,{selection:e,channels:n={}}){this.mark=function(t){const{channels:e}=t,n=new Set;let i=!1,s=!1;for(const t of e){const{channel:e,field:r,as:o}=t;if("orderby"===e)i=!0;else if(r)if(r.aggregate)s=!0;else{if(n.has(o))continue;n.add(o)}}return!i&&s&&n.size&&t.channels.push({channel:"orderby",value:Array.from(n)}),t}(t),this.selection=e;const i=Object.entries(Oe(n));this.channels=i.length?i:[["opacity",.2]],this.selection.addEventListener("value",o((()=>this.update())))}init(t){this.svg=t;const e=this.values=[],n=this.mark.index,i=this.nodes=t.querySelectorAll(`[data-index="${n}"] > *`),{channels:s}=this;for(let t=0;t<i.length;++t){const n=i[t];e.push(s.map((t=>n.getAttribute(t[0]))))}return this.update()}async update(){const{svg:t,nodes:e,channels:n,values:i,mark:s,selection:r}=this;if(!t)return;const o=await async function(t,e){const n=e?.predicate(t);if(!n||0===n.length)return()=>!0;const i=t.filterBy?.predicate(t,!0),s={__:$(n)},r=t.query(i);(r.queries||[r]).forEach((t=>{t.groupby().length?t.select(s):t.$select(s)}));const o=await t.coordinator.query(r),a=o.getChild?.("__");return o.numRows||o.length?a?t=>a.get(t):t=>o[t].__:()=>!1}(s,r);for(let t=0;t<e.length;++t){const s=e[t],r=i[t],a=s.__data__,l=o(Array.isArray(a)?a[0]:a);for(let t=0;t<n.length;++t){const[e,i]=n[t];s.setAttribute(e,l?r[t]:i)}}}}function Se(t){const e=t.on;let n=!0;function i(t){n=!1,t(),n=!0}return t.reset=(...e)=>{i((()=>t.clear(...e)))},t.moveSilent=(...e)=>{i((()=>t.move(...e)))},t.on=(...t)=>{if(t.length>1&&t[1]){const e=t[1];t[1]=(...t)=>n&&e(...t)}return e(...t)},t}function ke(t,e){return t===e||t&&e&&Math.abs(t[0]-e[0])<1e-12&&Math.abs(t[1]-e[1])<1e-12||!1}function Fe(t,e){const n=t.channelField(e)?.field;return n?.basis||n}function Te(t,e,n=1){return e.invert(n*Math.floor(t/n))}function Me(){const t=this,e=t.getScreenCTM;let n;t.getScreenCTM=()=>t.isConnected?n=e.call(t):n}class Ne{constructor(t,{channel:e,selection:n,field:i,pixelSize:s=1,peers:r=!0,brush:o}){this.mark=t,this.channel=e,this.pixelSize=s||1,this.selection=n,this.peers=r,this.field=i||Fe(t,e),this.style=o&&Oe(o),this.brush=Se("y"===e?it():nt()),this.brush.on("brush end",(({selection:t})=>this.publish(t)))}reset(){this.value=void 0,this.g&&this.brush.reset(this.g)}activate(){this.selection.activate(this.clause(this.value||[0,1]))}publish(t){let e;t&&(e=t.map((t=>Te(t,this.scale,this.pixelSize))).sort(((t,e)=>t-e))),ke(e,this.value)||(this.value=e,this.g.call(this.brush.moveSilent,t),this.selection.update(this.clause(e)))}clause(t){const{mark:e,pixelSize:n,field:i,scale:s}=this;return a(i,t,{source:this,clients:this.peers?e.plot.markSet:(new Set).add(e),scale:s,pixelSize:n})}init(t,e){const{brush:n,channel:i,style:s}=this;this.scale=t.scale(i);const r=t.scale("x").range,o=t.scale("y").range;n.extent([[st(r),st(o)],[rt(r),rt(o)]]);const a=this.value?.map(this.scale.apply).sort(Q),l=ot(t).selectAll('g[aria-label="facet"]');if(e=l.size()?l:ot(e??t),this.g=e.append("g").attr("class",`interval-${i}`).each(Me).call(n).call(n.moveSilent,a),s){const t=this.g.selectAll("rect.selection");for(const e in s)t.attr(e,s[e])}t.addEventListener("pointerenter",(t=>{t.buttons||this.activate()}))}}class $e{constructor(t,{selection:e,xfield:n,yfield:i,pixelSize:s=1,peers:r=!0,brush:o}){this.mark=t,this.pixelSize=s||1,this.selection=e,this.peers=r,this.xfield=n||Fe(t,"x"),this.yfield=i||Fe(t,"y"),this.style=o&&Oe(o),this.brush=Se(et()),this.brush.on("brush end",(({selection:t})=>this.publish(t)))}reset(){this.value=void 0,this.g&&this.brush.reset(this.g)}activate(){this.selection.activate(this.clause(this.value||[[0,1],[0,1]]))}publish(t){const{value:e,pixelSize:n,xscale:i,yscale:s}=this;let r,o;if(t){const[e,a]=t;r=[e[0],a[0]].map((t=>Te(t,i,n))).sort(Q),o=[e[1],a[1]].map((t=>Te(t,s,n))).sort(Q)}ke(r,e?.[0])&&ke(o,e?.[1])||(this.value=t?[r,o]:void 0,this.g.call(this.brush.moveSilent,t),this.selection.update(this.clause(this.value)))}clause(t){const{mark:e,pixelSize:n,xfield:i,yfield:s,xscale:r,yscale:o}=this;return l([i,s],t,{source:this,clients:this.peers?e.plot.markSet:(new Set).add(e),scales:[r,o],pixelSize:n})}init(t){const{brush:e,style:n}=this,i=this.xscale=t.scale("x"),s=this.yscale=t.scale("y"),r=i.range,o=s.range;e.extent([[st(r),st(o)],[rt(r),rt(o)]]);const a=ot(t).selectAll('g[aria-label="facet"]'),l=a.size()?a:ot(t);if(this.g=l.append("g").attr("class","interval-xy").each(Me).call(e),n){const t=this.g.selectAll("rect.selection");for(const e in n)t.attr(e,n[e])}if(this.value){const[t,n]=this.value[0].map(i.apply).sort(Q),[r,o]=this.value[1].map(s.apply).sort(Q);this.g.call(e.moveSilent,[[t,r],[n,o]])}t.addEventListener("pointerenter",(t=>{t.buttons||this.activate()}))}}class _e{constructor(t,{selection:e,pointer:n,channels:i,fields:s,maxRadius:r=40}){this.mark=t,this.selection=e,this.clients=(new Set).add(t),this.pointer=n,this.channels=i||("x"===n?["x"]:"y"===n?["y"]:["x","y"]),this.fields=s||this.channels.map((e=>Fe(t,[e]))),this.maxRadius=r,this.valueIndex=-1}clause(t){const{clients:e,fields:n}=this;return c(n,t?[t]:t,{source:this,clients:e})}init(t){const e=this,{mark:n,channels:i,selection:s,maxRadius:r}=this,{data:{columns:o}}=n,a=i.map((t=>n.channelField(t).as)),l=!h(s),c=ot(t).selectAll('g[aria-label="facet"]'),u=c.size()?c:ot(t),p=t.scale("x").apply,d=t.scale("y").apply,f=Array.from(o[n.channelField("x").as],p),y=Array.from(o[n.channelField("y").as],d),g="y"===this.pointer?.01:1,m="x"===this.pointer?.01:1;u.on("pointerenter pointerdown pointermove",(function(t){const[n,i]=at(t,this),c=function(t,e,n,i,s,r,o){let a=o*o,l=-1;for(let o=0;o<t.length;++o){const c=s*(t[o]-n),h=r*(e[o]-i),u=c*c+h*h;u<=a&&(a=u,l=o)}return l}(f,y,n,i,g,m,r);if(c!==this.valueIndex){this.valueIndex=c;const t=c<0?void 0:a.map((t=>o[t][c]));l?c>-1&&s.update(t.length>1?t:t[0]):s.update(e.clause(t))}})),l||(u.on("pointerleave",(()=>{s.update(e.clause(void 0))})),t.addEventListener("pointerenter",(t=>{if(!t.buttons){const t=this.channels.map((()=>0));s.activate(this.clause(t))}})))}}const Ie=(t,e)=>t-e;class De{constructor(t,{x:e=new u,y:n=new u,xfield:i,yfield:s,zoom:r=!0,panx:o=!0,pany:a=!0}){this.mark=t,this.xsel=e,this.ysel=n,this.xfield=i||Fe(t,"x"),this.yfield=s||Fe(t,"y"),this.zoom=qe(r,[0,1/0],[1,1]),this.panx=this.xsel&&o,this.pany=this.ysel&&a;const{plot:l}=t;o&&this.xsel.addEventListener("value",(t=>{l.setAttribute("xDomain",t)&&l.update()})),a&&this.ysel.addEventListener("value",(t=>{l.setAttribute("yDomain",t)&&l.update()}))}publish(t){if(this.panx){const e=function(t,e){return e.range.map(t.invertX,t).map(e.invert,e)}(t,this.xscale);this.xsel.update(this.clause(e,this.xfield,this.xscale))}if(this.pany){const e=function(t,e){return e.range.map(t.invertY,t).map(e.invert,e)}(t,this.yscale);this.ysel.update(this.clause(e,this.yfield,this.yscale))}}clause(t,e,n){return a(e,t,{source:this,clients:this.mark.plot.markSet,scale:n})}init(t){if(this.svg=t,this.initialized)return;this.initialized=!0;const{panx:e,pany:n,mark:{plot:{element:i}},xsel:s,ysel:r}=this;this.xscale=t.scale("x"),this.yscale=t.scale("y");const o=this.xscale.range.slice().sort(Ie),a=this.yscale.range.slice().sort(Ie),l=qe(e,[-1/0,1/0],o),c=qe(n,[-1/0,1/0],a),h=lt().extent([[o[0],a[0]],[o[1],a[1]]]).scaleExtent(this.zoom).translateExtent([[l[0],c[0]],[l[1],c[1]]]).on("start",(()=>{this.xscale=this.svg.scale("x"),this.yscale=this.svg.scale("y")})).on("end",(()=>i.__zoom=new ct(1,0,0))).on("zoom",(({transform:t})=>this.publish(t)));if(ot(i).call(h),e||n){let t=!1;i.addEventListener("pointerenter",(i=>{if(!t&&(t=!0,!i.buttons)){if(e){const{xscale:t,xfield:e}=this;s.activate(this.clause(t.domain,e,t))}if(n){const{yscale:t,yfield:e}=this;r.activate(this.clause(t.domain,e,t))}}})),i.addEventListener("pointerleave",(()=>t=!1))}}}function qe(t,e,n){return t?Array.isArray(t)?t:e:n}class ze{constructor(t,{selection:e,channels:n,peers:i=!0}){this.value=null,this.mark=t,this.selection=e,this.peers=i;const s=this.fields=[],r=this.as=[];n.forEach((e=>{const n="color"===e?["color","fill","stroke"]:"x"===e?["x","x1","x2"]:"y"===e?["y","y1","y2"]:[e];for(let e=0;e<n.length;++e){const i=t.channelField(n[e],{exact:!0});if(i)return s.push(i.field?.basis||i.field),void r.push(i.as)}throw new Error(`Missing channel: ${e}`)}))}clause(t){const{fields:e,mark:n}=this;return c(e,t,{source:this,clients:this.peers?n.plot.markSet:(new Set).add(n)})}init(t,e,n){const{mark:i,as:s,selection:r}=this,{data:{columns:o={}}={}}=i;n??=t=>s.map((e=>{const n=t.__data__;return o[e][Array.isArray(n)?n[0]:n]})),e??=`[data-index="${i.index}"]`;const a=new Set(t.querySelectorAll(e));t.addEventListener("pointerdown",(t=>{const e=r.single?r.value:this.value,i=t.target;let s=null;if(function(t,e){return t.has(e)||t.has(e.parentNode)||t.has(e.parentNode?.parentNode)}(a,i)){const r=n(i);(t.shiftKey||t.metaKey)&&e?.length?(s=e.filter((t=>Ge(t,r))),s.length===e.length&&s.push(r)):s=1!==e?.length||Ge(e[0],r)?[r]:null}var o,l;this.value=s,l=s,(null==(o=e)||null==l?null!=o||null!=l:o.length!==l.length||o.some(((t,e)=>Ge(t,l[e]))))&&r.update(this.clause(s))})),t.addEventListener("pointerenter",(t=>{t.buttons||this.selection.activate(this.clause([this.fields.map((()=>0))]))}))}}function Ge(t,e){const n=t.length;if(e.length!==n)return!0;for(let i=0;i<n;++i)if(t[i]!==e[i])return!0;return!1}const Be=":scope > div, :scope > span",Pe="swatch",je="ramp";class Ce{constructor(t,e){const{as:n,field:i,...s}=e;this.channel=t,this.options=s,this.type=null,this.handler=null,this.selection=n,this.field=i,this.legend=null,this.element=document.createElement("div"),this.element.setAttribute("class","legend"),Object.defineProperty(this.element,"value",{value:this})}setPlot(t){this.plot=t}init(t){const e=function(t,e){const{channel:n,plot:i,selection:s}=t,r=e.scale(n),o="ordinal"===r.type?Pe:je,a={label:i.getAttribute(`${n}Label`)??null,...t.options},l=o===Pe?a:a.label?{tickSize:2,...a}:{tickSize:2,marginTop:1,height:29,...a},c=e.legend(n,l);t.legend=c;let h=!!s;if(h&&o===je){const t=l.width??240,e=We(r,t);e?c.scale=function(i){return"x"===i?{range:[0,t]}:"y"===i?{range:[-10,0]}:i===n?e:void 0}:h=!1}if(h){const e=function(t,e){const{channel:n,handler:i,selection:s}=t;if(i)return i;const r=function(t){const{channel:e,plot:n}=t,i=t.field??function(t,e){const n="color"===e?["fill","stroke"]:"opacity"===e?["opacity","fillOpacity","strokeOpacity"]:null;if(null==n)return null;for(let e=t.length-1;e>-1;--e)for(const i of n){const n=t[e].channelField(i,{exact:!0});if(n)return n.field}return null}(n.marks,e)??"value";if(i){const t={field:i};return{plot:n,channelField:n=>e===n?t:void 0}}}(t);e===Pe?(t.handler=new ze(r,{selection:s,channels:[n],peers:!1}),s.addEventListener("value",(()=>t.update()))):t.handler=new Ne(r,{selection:s,channel:n,brush:{fill:"none",stroke:"currentColor"},peers:!1});return t.handler}(t,o);o===Pe?(e.init(c,Be,(t=>[t.__data__])),t.update()):e.init(c,c.querySelector("g:last-of-type"))}return c}(this,t);return this.element.replaceChildren(e),this.element}update(){if(!this.legend)return;const{selection:t,handler:e}=this,{single:n,value:i}=t,s=n?i:t.valueFor(e),r=s&&s.length?new Set(s.map((t=>t[0]))):null,o=this.legend.querySelectorAll(Be);for(const t of o){const e=!r||r.has(t.__data__);t.style.opacity=e?1:.2}}}function We(t,e){const{apply:n,invert:i,interpolate:s,...r}=t;let o,a=t.type;switch(a.startsWith("diverging-")&&(a=a.slice(11)),a){case"log":case"pow":case"sqrt":case"symlog":o=a;break;case"threshold":case"quantize":case"quantile":return console.warn(`Legends do not yet support ${a} scales.`),null;default:o="linear"}return g({x:{...r,type:o,range:[0,e]}})}function Ue(t,e,n=0,i=Math.LN10){let s;const r=Math.ceil(Math.log(e)/i);let o=Math.max(n,Math.pow(10,Math.round(Math.log(t)/i)-r));for(;Math.ceil(t/o)>e;)o*=10;const a=[5,2];for(let i=0,r=a.length;i<r;++i)s=o/a[i],s>=n&&t/s<=e&&(o=s);return o}const He="year",Xe="month",Ye="hour",Ve="minute",Ze="second",Qe="millisecond",Ke=1e3,Je=6e4,tn=36e5,en=864e5,nn=2592e6,sn=[[Ze,1,Ke],[Ze,5,5e3],[Ze,15,15e3],[Ze,30,3e4],[Ve,1,Je],[Ve,5,3e5],[Ve,15,9e5],[Ve,30,18e5],[Ye,1,tn],[Ye,3,108e5],[Ye,6,216e5],[Ye,12,432e5],["day",1,en],["day",7,6048e5],[Xe,1,nn],[Xe,3,7776e6],[He,1,31536e6]];const rn=new Set(["rectY-x","rectX-y","rect-x","rect-y","ruleY-x","ruleX-y"]);function on(t,e={}){const n=(n,i)=>function(t,e){return rn.has(`${t.type}-${e}`)}(n,i)?{[`${i}1`]:an(n,i,t,e),[`${i}2`]:an(n,i,t,{...e,offset:1})}:{[i]:an(n,i,t,e)};return n[dt]=!0,n}function an(t,e,n,i){return{column:n,label:n,get columns(){return[n]},get basis(){return n},get stats(){return{column:n,stats:["min","max"]}},toString(){const{type:s,min:r,max:o}=t.channelField(e),{interval:a,steps:l,offset:c=0}=i,h=a??("date"===s||function(t,e){const n=t.plot.getAttribute(`${e}Scale`);return"utc"===n||"time"===n}(t,e)?"date":"number");if("number"===h){const{apply:s,sqlApply:a,sqlInvert:l}=Dt(t,e),h=function(t,e,n){let{step:i,steps:s,minstep:r=0,nice:o=!0}=n;if(!1!==o){const n=e-t,o=Math.LN10;i=i||Ue(n,s||25,r,o);let a=Math.log(i);const l=a>=0?0:1+~~(-a/o),c=Math.pow(10,-l-1);a=Math.floor(t/i+c)*i,t=t<a?a-i:a,e=Math.ceil(e/i)*i,s=Math.round((e-t)/i)}return{min:t,max:e,steps:s}}(s(r),s(o),i),u=a(n),p=0===h.min?u:`(${u} - ${h.min})`,d=(h.max-h.min)/h.steps+"::DOUBLE",f=c?`${c} + `:"";return`${l(`${h.min} + ${d} * (${f}FLOOR(${p} / ${d}))`)}`}{const{interval:t,step:e=1}="date"===h?function(t,e,n){const i=e-t,s=i/n;let r=ht((t=>t[2])).right(sn,s);return r===sn.length?{interval:He,step:Ue(i,n)}:r?(r=sn[s/sn[r-1][2]<sn[r][2]/s?r-1:r],{interval:r[0],step:r[1]}):{interval:Qe,step:Ue(i,n,1)}}(r,o,l||40):i,s=c?` + INTERVAL ${c*e} ${t}`:"";return`(${X(n,t,e)}${s})`}}}}export{Ut as ConnectedMark,ee as ContourMark,he as DenseLineMark,ue as Density1DMark,pe as Density2DMark,me as ErrorBarMark,ut as Fixed,xe as GeoMark,te as Grid2DMark,ae as HeatmapMark,be as HexbinMark,Le as Highlight,Ne as Interval1D,$e as Interval2D,Ce as Legend,Nt as Mark,_e as Nearest,De as PanZoom,wt as Plot,oe as RasterMark,Ee as RasterTileMark,Ae as RegressionMark,ze as Toggle,dt as Transform,pt as Transient,on as bin};export default null;
