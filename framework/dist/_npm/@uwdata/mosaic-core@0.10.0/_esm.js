/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@uwdata/mosaic-core@0.10.0/src/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{tableFromIPC as e,DataType as t}from"../../apache-arrow@16.1.0/_esm.js";import{agg as n,sql as r,create as s,asColumn as i,isBetween as c,and as o,scaleTransform as u,Query as l,Ref as a,isDescribeQuery as h,asRelation as f,count as d,max as p,min as m,isNull as g,or as y,isNotDistinct as v,literal as b,contains as _,prefix as $,suffix as w,regexp_matches as q}from"../mosaic-sql@0.10.0/_esm.js";import*as E from"../../@duckdb/duckdb-wasm@1.28.0/_esm.js";const A={};function S(e,t=!1){let n,r,s=A;function i(t){n=e(t).then((()=>{if(r){const{value:e}=r;r=null,i(e)}else n=null}))}function c(e){n?function(e){r={event:e}}(e):i(e)}return t?function(e){s!==e&&requestAnimationFrame((()=>{const e=s;s=A,c(e)})),s=e}:c}class x{constructor(e){this._filterBy=e,this._requestUpdate=S((()=>this.requestQuery()),!0),this._coordinator=null}get coordinator(){return this._coordinator}set coordinator(e){this._coordinator=e}get filterBy(){return this._filterBy}get filterIndexable(){return!0}fields(){return null}fieldInfo(e){return this}query(e){return null}queryPending(){return this}queryResult(e){return this}queryError(e){return this}requestQuery(e){const t=e||this.query(this.filterBy?.predicate(this));return this._coordinator.requestQuery(this,t)}requestUpdate(){this._requestUpdate()}update(){return this}}function R(t="ws://localhost:3000/"){const n=[];let r,s=!1,i=null;const c={open(){s=!0,u()},close(){for(s=!1,i=null,r=null;n.length;)n.shift().reject("Socket closed")},error(e){if(i){const{reject:t}=i;i=null,u(),t(e)}else console.error("WebSocket error: ",e)},message({data:t}){if(i){const{query:n,resolve:r,reject:s}=i;if(i=null,u(),"string"==typeof t){const e=JSON.parse(t);e.error?s(e.error):r(e)}else if("exec"===n.type)r();else{if("arrow"!==n.type)throw new Error(`Unexpected socket data: ${t}`);r(e(t.arrayBuffer()))}}else console.log("WebSocket message: ",t)}};function o(e,o,l){null==r&&function(){r=new WebSocket(t);for(const e in c)r.addEventListener(e,c[e])}(),n.push({query:e,resolve:o,reject:l}),s&&!i&&u()}function u(){n.length&&(i=n.shift(),r.send(JSON.stringify(i.query)))}return{get connected(){return s},query:e=>new Promise(((t,n)=>o(e,t,n)))}}function k(e){if(!e.filterIndexable)return null;const t=e.query(),r=I(t);if("string"!=typeof r||!t.select)return null;const s=[],i=[],c={};for(const e of t.select()){const{as:t,expr:{aggregate:o,args:u}}=e,l=o?.toUpperCase?.();switch(l){case"COUNT":case"SUM":s.push({[t]:n`SUM("${t}")::DOUBLE`});break;case"AVG":s.push({[t]:U(c,t,u[0])});break;case"ARG_MAX":s.push({[t]:O(c,t,u)});break;case"ARG_MIN":s.push({[t]:N(c,t,u)});break;case"VARIANCE":case"VAR_SAMP":c[t]=null,s.push({[t]:G(c,u[0],r)});break;case"VAR_POP":c[t]=null,s.push({[t]:G(c,u[0],r,!1)});break;case"STDDEV":case"STDDEV_SAMP":c[t]=null,s.push({[t]:n`SQRT(${G(c,u[0],r)})`});break;case"STDDEV_POP":c[t]=null,s.push({[t]:n`SQRT(${G(c,u[0],r,!1)})`});break;case"COVAR_SAMP":c[t]=null,s.push({[t]:D(c,u,r)});break;case"COVAR_POP":c[t]=null,s.push({[t]:D(c,u,r,!1)});break;case"CORR":c[t]=null,s.push({[t]:B(c,u,r)});break;case"REGR_COUNT":c[t]=null,s.push({[t]:n`${P(c,u)}::DOUBLE`});break;case"REGR_AVGX":c[t]=null,s.push({[t]:V(c,u)});break;case"REGR_AVGY":c[t]=null,s.push({[t]:W(c,u)});break;case"REGR_SYY":c[t]=null,s.push({[t]:z(c,0,u,r)});break;case"REGR_SXX":c[t]=null,s.push({[t]:z(c,1,u,r)});break;case"REGR_SXY":c[t]=null,s.push({[t]:D(c,u,r,null)});break;case"REGR_SLOPE":c[t]=null,s.push({[t]:Y(c,u,r)});break;case"REGR_INTERCEPT":c[t]=null,s.push({[t]:X(c,u,r)});break;case"REGR_R2":c[t]=null,s.push({[t]:n`(${B(c,u,r)}) ** 2`});break;case"MAX":case"MIN":case"BIT_AND":case"BIT_OR":case"BIT_XOR":case"BOOL_AND":case"BOOL_OR":case"PRODUCT":s.push({[t]:n`${l}("${t}")`});break;default:if(o)return null;i.push(t)}}return s.length?{from:r,dims:i,aggr:s,aux:c}:null}function M(e,...t){return`__${e}${t.length?"_"+t.map(T).join("_"):""}__`}function T(e){return`${e}`.replaceAll('"',"").replaceAll(" ","_")}function I(e){const t=e.subqueries;if(e.select){const n=e.from();if(!n.length)return;if(0===t.length)return n[0].from.table}const n=I(t[0]);for(let e=1;e<t.length;++e){const r=I(t[e]);if(void 0!==r&&r!==n)return NaN}return n}function C(e,t){const r=M("count",t);return e[r]=n`COUNT(${t})`,n`SUM(${r})`.annotate({name:r})}function U(e,t,r){const s=C(e,r);return n`(SUM("${t}" * ${s.name}) / ${s})`}function L(e,t){return r`(SELECT AVG(${e}) FROM "${t}")`}function O(e,t,[,r]){const s=M("max",r);return e[s]=n`MAX(${r})`,n`ARG_MAX("${t}", ${s})`}function N(e,t,[,r]){const s=M("min",r);return e[s]=n`MIN(${r})`,n`ARG_MIN("${t}", ${s})`}function G(e,t,s,i=!0){const c=C(e,t),o=M("rssq",t),u=M("rsum",t),l=r`${t} - ${L(t,s)}`;e[o]=n`SUM((${l}) ** 2)`,e[u]=n`SUM(${l})`;return n`(SUM(${o}) - (SUM(${u}) ** 2 / ${c})) / (${c}${i?" - 1":""})`}function D(e,t,r,s=!0){const i=P(e,t),c=Q(e,t,r),o=j(e,1,t,r),u=j(e,0,t,r);return n`(${c} - ${o} * ${u} / ${i})${null===s?"":s?` / (${i} - 1)`:` / ${i}`}`}function B(e,t,r){const s=P(e,t),i=Q(e,t,r),c=F(e,1,t,r),o=F(e,0,t,r),u=j(e,1,t,r),l=j(e,0,t,r),a=n`(${c} - (${u} ** 2) / ${s})`,h=n`(${o} - (${l} ** 2) / ${s})`;return n`(${i} - ${u} * ${l} / ${s}) / SQRT(${a} * ${h})`}function P(e,[t,r]){const s=M("count",t,r);return e[s]=n`REGR_COUNT(${t}, ${r})`,n`SUM(${s})`.annotate({name:s})}function j(e,t,r,s){const i=r[t],c=r[1-t],o=M("rs",i);return e[o]=n`SUM(${i} - ${L(i,s)}) FILTER (${c} IS NOT NULL)`,n`SUM(${o})`}function F(e,t,r,s){const i=r[t],c=r[1-t],o=M("rss",i);return e[o]=n`SUM((${i} - ${L(i,s)}) ** 2) FILTER (${c} IS NOT NULL)`,n`SUM(${o})`}function Q(e,t,r){const[s,i]=t,c=M("sxy",s,i);return e[c]=n`SUM((${i} - ${L(i,r)}) * (${s} - ${L(s,r)}))`,n`SUM(${c})`}function V(e,t){const[r,s]=t,i=P(e,t),c=M("avg",s,r);return e[c]=n`REGR_AVGX(${r}, ${s})`,n`(SUM(${c} * ${i.name}) / ${i})`}function W(e,t){const[r,s]=t,i=P(e,t),c=M("avg",r,s);return e[c]=n`REGR_AVGY(${r}, ${s})`,n`(SUM(${c} * ${i.name}) / ${i})`}function z(e,t,r,s){const i=P(e,r),c=j(e,t,r,s),o=F(e,t,r,s);return n`(${o} - (${c} ** 2 / ${i}))`}function Y(e,t,r){const s=D(e,t,r,null),i=z(e,1,t,r);return n`(${s}) / ${i}`}function X(e,t,r){const s=V(e,t),i=W(e,t),c=Y(e,t,r);return n`${i} - (${c}) * ${s}`}function H(e){return e+(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24)}const J={skip:!0,result:null};class Z{constructor(e,{enabled:t=!0,temp:n=!0}={}){this.indexes=new Map,this.active=null,this.temp=n,this.mc=e,this._enabled=t}enabled(e){if(void 0===e)return this._enabled;this._enabled!==e&&(e||this.clear(),this._enabled=e)}clear(){this.mc.cancel(Array.from(this.indexes.values(),(e=>e?.result))),this.indexes.clear(),this.active=null}index(e,t,n){if(!this._enabled)return null;const{indexes:a,mc:h,temp:f}=this,{source:d}=n;if(!d)return null;if(this.active&&(this.active.source!==d&&this.clear(),null===this.active?.source))return null;let{active:p}=this;if(!p&&(this.active=p=function(e){const{source:t,meta:n}=e,s=e.predicate,l=s?.columns;let a,h;if(!n||!l)return{source:null,columns:h,predicate:a};const{type:f,scales:d,bin:p,pixelSize:m=1}=n;if("point"===f)a=e=>e,h=Object.fromEntries(l.map((e=>[`${e}`,i(e)])));else if("interval"===f&&d){const e=d.map((e=>function(e,t,n){const{type:s,domain:i,range:c,apply:o,sqlApply:l}=u(e);if(!o)return;const a=K[`${n}`.toLowerCase()]||"FLOOR",h=o(Math.min(...i)),f=o(Math.max(...i)),d="identity"===s?1:Math.abs(c[1]-c[0])/(f-h),p=d/t==1?"":d/t+"::DOUBLE * ",m=0===h?"":` - ${h}::DOUBLE`;return e=>r`${a}(${p}(${l(e)}${m}))::INTEGER`}(e,m,p)));e.some((e=>!e))||(1===e.length?(a=t=>t?c("active0",t.range.map(e[0])):[],h={active0:e[0](s.field)}):(a=t=>t?o(t.children.map((({range:t},n)=>c(`active${n}`,t.map(e[n]))))):[],h=Object.fromEntries(s.children.map(((t,n)=>[`active${n}`,e[n](t.field)])))))}return{source:h?t:null,columns:h,predicate:a}}(n),null===p.source))return null;if(a.has(e))return a.get(e);const m=k(e);let g;if(m)if(t.skip(e,n))g=J;else{const n=t.remove(d).predicate(e);g=function(e,t,n){const{dims:r,aggr:s,aux:i}=n,{columns:c}=t,o=e.select({...c,...i}).groupby(Object.keys(c)),[u]=o.subqueries;if(u){!function(e,t){const n=new Set,r=e=>{n.has(e)||(n.add(e),e.select&&e.from().length&&e.select(t),e.subqueries.forEach(r))};r(e)}(u,Object.values(c).flatMap((e=>e.columns)))}const a=o.orderby();o.query.orderby=[];const h=o.toString(),f=(function(e){let t=2166136261;for(let n=0,r=e.length;n<r;++n){const r=e.charCodeAt(n),s=65280&r;s&&(t=H(t^s>>8)),t=H(t^255&r)}return function(e){return e+=e<<13,e^=e>>>7,e+=e<<3,e^=e>>>17,4294967295&(e+=e<<5)}(t)}(h)>>>0).toString(16),d=`cube_index_${f}`,p=l.select(r,s).from(d).groupby(r).orderby(a);return new ee({table:d,create:h,active:t,select:p})}(e.query(n),p,m),g.result=h.exec(s(g.table,g.create,{temp:f})),g.result.catch((e=>h.logger().error(e)))}else g=null;return a.set(e,g),g}}const K={ceil:"CEIL",round:"ROUND"};class ee{constructor({table:e,create:t,active:n,select:r}={}){this.table=e,this.create=t,this.result=null,this.active=n,this.select=r,this.skip=!1}query(e){return this.select.clone().where(this.active.predicate(e))}}class te extends Promise{constructor(){let e,t;super(((n,r)=>{e=n,t=r})),this._resolve=e,this._reject=t}fulfill(e){return this._resolve(e),this}reject(e){return this._reject(e),this}}function ne(e,t,n){let r=[],s=0;function i(){const i=function(e,t){const n=[],r=new Map;for(const s of e){const{entry:{request:e}}=s,i=re(e.query,t);if(!r.has(i)){const e=[];n.push(e),r.set(i,e)}r.get(i).push(s)}return n}(r,t);r=[],s=0;for(const r of i)se(r,e,n),ce(r,t)}return{add(t,n){"arrow"===t.request.type?(s=s||("undefined"!=typeof requestAnimationFrame?requestAnimationFrame:"undefined"!=typeof setImmediate?setImmediate:setTimeout)((()=>i())),r.push({entry:t,priority:n,index:r.length})):e(t,n)}}}function re(e,t){const n=`${e}`;if(e instanceof l&&!t.get(n)){if(e.orderby().length||e.where().length||e.qualify().length||e.having().length)return n;const t=e.clone().$select("*"),r=e.groupby();if(r.length){const n={};e.select().forEach((({as:e,expr:t})=>n[e]=t)),t.$groupby(r.map((e=>e instanceof a&&n[e.column]||e)))}return`${t}`}return n}function se(e,t,n){if(function(e){if(e.length>1){const t=`${e[0].entry.request.query}`;for(let n=1;n<e.length;++n)if(t!==`${e[n].entry.request.query}`)return!0}return!1}(e))t({request:{type:"arrow",cache:!1,record:!1,query:e.query=ie(e,n)},result:e.result=new te});else for(const{entry:n,priority:r}of e)t(n,r)}function ie(e,t){const n=e.maps=[],r=new Map;for(const s of e){const{query:e}=s.entry.request,i=[];n.push(i);for(const{as:t,expr:n}of e.select()){const e=`${n}`;r.has(e)||r.set(e,[`col${r.size}`,n]);const[s]=r.get(e);i.push([s,t])}t(`${e}`)}const s=e[0].entry.request.query.clone(),i=s.groupby();if(i.length){const t={};e.maps[0].forEach((([e,n])=>t[n]=e)),s.$groupby(i.map((e=>e instanceof a&&t[e.column]||e)))}return s.$select(Array.from(r.values()))}async function ce(e,t){const{maps:n,query:r,result:s}=e;if(!n)return;let i;try{i=await s}catch(t){for(const{entry:n}of e)n.result.reject(t);return}const c=h(r);e.forEach((({entry:e},r)=>{const{request:s,result:o}=e,u=n[r],l=c&&u?function(e,t){const n=new Map(t),r=[];for(const t of e)n.has(t.column_name)&&r.push({...t,column_name:n.get(t.column_name)});return r}(i,u):u?function(e,t){const n={};for(const[r,s]of t)n[s]=e.getChild(r);return new e.constructor(n)}(i,u):i;s.cache&&t.set(String(s.query),l),o.fulfill(l)}))}te.prototype.constructor=Promise;const oe="undefined"!=typeof requestIdleCallback?requestIdleCallback:setTimeout;const ue={High:0,Normal:1,Low:2};class le{constructor(){this.queue=function(e){const t=Array.from({length:e},(()=>({head:null,tail:null})));return{isEmpty:()=>t.every((e=>!e.head)),insert(e,n){const r=t[n];if(!r)throw new Error(`Invalid queue priority rank: ${n}`);const s={item:e,next:null};null===r.head?r.head=r.tail=s:r.tail=r.tail.next=s},remove(e){for(const n of t){let{head:t,tail:r}=n;for(let n=null,s=t;s;n=s,s=s.next)e(s.item)&&(s===t?t=s.next:n.next=s.next,s===r&&(r=n||t));n.head=t,n.tail=r}},next(){for(const e of t){const{head:t}=e;if(null!==t)return e.head=t.next,e.tail===t&&(e.tail=null),t.item}}}}(3),this.db=null,this.clientCache=null,this._logger=null,this._logQueries=!1,this.recorders=[],this.pending=null,this._consolidate=null}next(){if(this.pending||this.queue.isEmpty())return;const{request:e,result:t}=this.queue.next();this.pending=this.submit(e,t),this.pending.finally((()=>{this.pending=null,this.next()}))}enqueue(e,t=ue.Normal){this.queue.insert(e,t),this.next()}recordQuery(e){this.recorders.length&&e&&this.recorders.forEach((t=>t.add(e)))}async submit(e,t){try{const{query:n,type:r,cache:s=!1,record:i=!0,options:c}=e,o=n?`${n}`:null;if(i&&this.recordQuery(o),s){const e=this.clientCache.get(o);if(e)return this._logger.debug("Cache"),void t.fulfill(e)}const u=performance.now();this._logQueries&&this._logger.debug("Query",{type:r,sql:o,...c});const l=await this.db.query({type:r,sql:o,...c});s&&this.clientCache.set(o,l),this._logger.debug(`Request: ${(performance.now()-u).toFixed(1)}`),t.fulfill(l)}catch(e){t.reject(e)}}cache(e){return void 0!==e?this.clientCache=!0===e?function({max:e=1e3,ttl:t=108e5}={}){let n=new Map;function r(){const e=performance.now()-t;let r=null,s=1/0;for(const[t,i]of n){const{last:c}=i;c<s&&(r=t,s=c),e>c&&n.delete(t)}r&&n.delete(r)}return{get(e){const t=n.get(e);if(t)return t.last=performance.now(),t.value},set:(t,s)=>(n.set(t,{last:performance.now(),value:s}),n.size>e&&oe(r),s),clear(){n=new Map}}}():e||{get:()=>{},set:(e,t)=>t,clear:()=>{}}:this.clientCache}logger(e){return e?this._logger=e:this._logger}logQueries(e){return void 0!==e?this._logQueries=!!e:this._logQueries}connector(e){return e?this.db=e:this.db}consolidate(e){e&&!this._consolidate?this._consolidate=ne(this.enqueue.bind(this),this.clientCache,this.recordQuery.bind(this)):!e&&this._consolidate&&(this._consolidate=null)}request(e,t=ue.Normal){const n=new te,r={request:e,result:n};return this._consolidate?this._consolidate.add(r,t):this.enqueue(r,t),n}cancel(e){const t=new Set(e);t.size&&this.queue.remove((({result:e})=>t.has(e)))}clear(){this.queue.remove((({result:e})=>(e.reject("Cleared"),!0)))}record(){let e=[];const t={add(t){e.push(t)},reset(){e=[]},snapshot:()=>e.slice(),stop(){return this.recorders=this.recorders.filter((e=>e!==t)),e}};return this.recorders.push(t),t}}function ae(e){switch(e){case"BIGINT":case"HUGEINT":case"INTEGER":case"SMALLINT":case"TINYINT":case"UBIGINT":case"UINTEGER":case"USMALLINT":case"UTINYINT":case"DOUBLE":case"FLOAT":case"REAL":return"number";case"DATE":case"TIMESTAMP":case"TIMESTAMPTZ":case"TIMESTAMP WITH TIME ZONE":case"TIME":case"TIMESTAMP_NS":return"date";case"BOOLEAN":return"boolean";case"VARCHAR":case"UUID":case"JSON":return"string";case"ARRAY":case"LIST":return"array";case"BLOB":case"STRUCT":case"MAP":case"GEOMETRY":return"object";default:if(e.startsWith("DECIMAL"))return"number";if(e.startsWith("STRUCT")||e.startsWith("MAP"))return"object";if(e.endsWith("]"))return"array";throw new Error(`Unsupported type: ${e}`)}}function he(e){return"function"==typeof e?.getChild}function fe(e){return t.isInt(e)||t.isFloat(e)||t.isDecimal(e)?Float64Array:Array}function de(e){if(t.isTimestamp(e))return e=>null==e?e:new Date(e);if(t.isInt(e)&&e.bitWidth>=64)return e=>null==e?e:Number(e);if(t.isDecimal(e)){const t=1/Math.pow(10,e.scale);return e=>null==e?e:ge(e,t)}return e=>e}function pe(e){const{type:n}=e;if(t.isTimestamp(n)){const t=e.length,n=new Array(t);for(let r=0;r<t;++r){const t=e.get(r);n[r]=null==t?null:new Date(t)}return n}if(t.isInt(n)&&n.bitWidth>=64){const t=e.length,n=e.nullCount?new Array(t):new Float64Array(t);for(let r=0;r<t;++r){const t=e.get(r);n[r]=null==t?null:Number(t)}return n}if(t.isDecimal(n)){const t=1/Math.pow(10,n.scale),r=e.length,s=e.nullCount?new Array(r):new Float64Array(r);for(let n=0;n<r;++n){const r=e.get(n);s[n]=null==r?null:ge(r,t)}return s}return e.nullCount?Array.from(e):e.toArray()}const me=Array.from({length:8},((e,t)=>Math.pow(2,32*t)));function ge(e,t){const n=e.length;let r=0;if(e.signed&&(0|e[n-1])<0){for(let t=0;t<n;++t)r+=~e[t]*me[t];r=-(r+1)}else for(let t=0;t<n;++t)r+=e[t]*me[t];return r*t}const ye={count:d,distinct:e=>d(e).distinct(),max:p,min:m,nulls:e=>d().where(g(e))};async function ve(e,t){return 1===t.length&&"*"==`${t[0].column}`?async function(e,t){const n=await e.query(`DESCRIBE ${f(t)}`);return Array.from(n).map((e=>({table:t,column:e.column_name,sqlType:e.column_type,type:ae(e.column_type),nullable:"YES"===e.null})))}(e,t[0].table):(await Promise.all(t.map((t=>async function(e,{table:t,column:n,stats:s}){const i=l.from({source:t}).select({column:n}).groupby(n.aggregate?r`ALL`:[]),[c]=Array.from(await e.query(l.describe(i))),o={table:t,column:`${n}`,sqlType:c.column_type,type:ae(c.column_type),nullable:"YES"===c.null};if(!s?.length&&!s?.size)return o;const u=await e.query(function(e,t,n){return l.from(e).select(Array.from(n,(e=>[e,ye[e](t)])))}(t,n,s),{persist:!0});for(let e=0;e<u.numCols;++e){const{name:t}=u.schema.fields[e],n=u.getChildAt(e),r=de(n.type);o[t]=r(n.get(0))}return o}(e,t))))).filter((e=>e))}let be;function _e(e){return e?be=e:null==be&&(be=new $e),be}class $e{constructor(e=R(),{logger:t=console,manager:n=new le,cache:r=!0,consolidate:s=!0,indexes:i={}}={}){this.manager=n,this.manager.cache(r),this.manager.consolidate(s),this.dataCubeIndexer=new Z(this,i),this.logger(t),this.databaseConnector(e),this.clear()}clear({clients:e=!0,cache:t=!0}={}){this.manager.clear(),e&&(this.filterGroups?.forEach((e=>e.disconnect())),this.filterGroups=new Map,this.clients?.forEach((e=>this.disconnect(e))),this.clients=new Set),t&&this.manager.cache().clear()}databaseConnector(e){return this.manager.connector(e)}logger(e){return arguments.length&&(this._logger=e||{debug(){},info(){},log(){},warn(){},error(){}},this.manager.logger(this._logger)),this._logger}cancel(e){this.manager.cancel(e)}exec(e,{priority:t=ue.Normal}={}){return e=Array.isArray(e)?e.join(";\n"):e,this.manager.request({type:"exec",query:e},t)}query(e,{type:t="arrow",cache:n=!0,priority:r=ue.Normal,...s}={}){return this.manager.request({type:t,query:e,cache:n,options:s},r)}prefetch(e,t={}){return this.query(e,{...t,cache:!0,priority:ue.Low})}createBundle(e,t,n=ue.Low){const r={name:e,queries:t};return this.manager.request({type:"create-bundle",options:r},n)}loadBundle(e,t=ue.High){const n={name:e};return this.manager.request({type:"load-bundle",options:n},t)}updateClient(e,t,n=ue.Normal){return e.queryPending(),this.query(t,{priority:n}).then((t=>e.queryResult(t).update()),(t=>{this._logger.error(t),e.queryError(t)})).catch((e=>this._logger.error(e)))}requestQuery(e,t){return this.dataCubeIndexer.clear(),t?this.updateClient(e,t):e.update()}async connect(e){const{clients:t}=this;if(t.has(e))throw new Error("Client already connected.");t.add(e),e.coordinator=this;const n=e.fields();n?.length&&e.fieldInfo(await ve(this,n)),function(e,t,n){if(!t)return;let r=e.filterGroups.get(t);if(!r){const n=n=>function(e,t,n){const{dataCubeIndexer:r,filterGroups:s}=e,{clients:i}=s.get(t);for(const e of i)r.index(e,t,n)}(e,t,n),s=()=>function(e,t){const{dataCubeIndexer:n,filterGroups:r}=e,{clients:s}=r.get(t),{active:i}=t;return Promise.allSettled(Array.from(s,(r=>{const s=n.index(r,t,i),c=s?null:t.predicate(r);if(s?.skip||!s&&!c)return;const o=s?.query(i.predicate)??r.query(c);return e.updateClient(r,o)})))}(e,t);t.addEventListener("activate",n),t.addEventListener("value",s),r={selection:t,clients:new Set,disconnect(){t.removeEventListener("activate",n),t.removeEventListener("value",s)}},e.filterGroups.set(t,r)}r.clients.add(n)}(this,e.filterBy,e),e.requestQuery()}disconnect(e){const{clients:t,filterGroups:n}=this;if(!t.has(e))return;t.delete(e),e.coordinator=null;const r=n.get(e.filterBy);r&&r.clients.delete(e)}}class we{constructor(){this._callbacks=new Map}addEventListener(e,t){this._callbacks.has(e)||this._callbacks.set(e,{callbacks:new Set,pending:null,queue:new qe});this._callbacks.get(e).callbacks.add(t)}removeEventListener(e,t){const n=this._callbacks.get(e);n&&n.callbacks.delete(t)}willEmit(e,t){return t}emitQueueFilter(e,t){return null}cancel(e){const t=this._callbacks.get(e);t?.queue.clear()}async pending(e){await(this._callbacks.get(e)?.pending)}emit(e,t){const n=this._callbacks.get(e)||{};if(n.pending)n.queue.enqueue(t,this.emitQueueFilter(e,t));else{const r=this.willEmit(e,t),{callbacks:s,queue:i}=n;if(s?.size){const t=Array.from(s,(e=>e(r)));n.pending=Promise.allSettled(t).then((()=>{n.pending=null,i.isEmpty()||this.emit(e,i.dequeue())}))}}}}class qe{constructor(){this.clear()}clear(){this.next=null}isEmpty(){return!this.next}enqueue(e,t){const n={value:e};if(t&&this.next){let e=this;for(;e.next;)t(e.next.value)?e=e.next:e.next=e.next.next;e.next=n}else this.next=n}dequeue(){const{next:e}=this;return this.next=e?.next,e?.value}}function Ee(e,t){return e!==t&&(e instanceof Date&&t instanceof Date?+e!=+t:!Array.isArray(e)||!Array.isArray(t)||function(e,t){if(e.length!==t.length)return!0;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!0;return!1}(e,t))}function Ae(e){return e instanceof Se}class Se extends we{constructor(e){super(),this._value=e}static value(e){return new Se(e)}static array(e){if(e.some((e=>Ae(e)))){const t=new Se,n=()=>{t.update(e.map((e=>Ae(e)?e.value:e)))};return n(),e.forEach((e=>Ae(e)?e.addEventListener("value",n):0)),t}return new Se(e)}get value(){return this._value}update(e,{force:t}={}){return Ee(this._value,e)||t?this.emit("value",e):this.cancel("value"),this}willEmit(e,t){return"value"===e&&(this._value=t),t}}function xe(e){return e instanceof Re}class Re extends Se{static intersect({cross:e=!1,empty:t=!1}={}){return new Re(new ke({cross:e,empty:t}))}static union({cross:e=!1,empty:t=!1}={}){return new Re(new ke({cross:e,empty:t,union:!0}))}static single({cross:e=!1,empty:t=!1}={}){return new Re(new ke({cross:e,empty:t,single:!0}))}static crossfilter({empty:e=!1}={}){return new Re(new ke({cross:!0,empty:e}))}constructor(e=new ke){super([]),this._resolved=this._value,this._resolver=e}clone(){const e=new Re(this._resolver);return e._value=e._resolved=this._value,e}remove(e){const t=this.clone();return t._value=t._resolved=t._resolver.resolve(this._resolved,{source:e}),t._value.active={source:e},t}get resolver(){return this._resolver}get single(){return this._resolver.single}get clauses(){return super.value}get active(){return this.clauses.active}get value(){return this.active?.value}valueFor(e){return this.clauses.find((t=>t.source===e))?.value}activate(e){this.emit("activate",e)}update(e){return this._resolved=this._resolver.resolve(this._resolved,e,!0),this._resolved.active=e,super.update(this._resolved)}willEmit(e,t){return"value"===e?(this._value=t,this.value):t}emitQueueFilter(e,t){return"value"===e?this._resolver.queueFilter(t):null}skip(e,t){return this._resolver.skip(e,t)}predicate(e,t=!1){const{clauses:n}=this,r=t?null:n.active;return this._resolver.predicate(n,r,e)}}class ke{constructor({union:e,cross:t,single:n,empty:r}={}){this.union=!!e,this.cross=!!t,this.single=!!n,this.empty=!!r}resolve(e,t,n=!1){const{source:r,predicate:s}=t,i=e.filter((e=>r!==e.source)),c=this.single?[]:i;return this.single&&n&&i.forEach((e=>e.source?.reset?.())),s&&c.push(t),c}skip(e,t){return this.cross&&t?.clients?.has(e)}predicate(e,t,n){const{empty:r,union:s}=this;if(r&&!e.length)return["FALSE"];if(this.skip(n,t))return;const i=e.filter((e=>!this.skip(n,e))).map((e=>e.predicate));return s&&i.length>1?y(i):i}queueFilter(e){if(this.cross){const t=e.active?.source;return e=>e.active?.source!==t}return null}}function Me(t="http://localhost:3000/"){return{async query(n){const r=fetch(t,{method:"POST",mode:"cors",cache:"no-cache",credentials:"omit",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return"exec"===n.type?r:"arrow"===n.type?e(r):(await r).json()}}}function Te(e={}){const{duckdb:t,connection:n,...r}=e;let s,i=t,c=n;function o(){return s||(s=(i?Promise.resolve(i):Ie(r).then((e=>i=e))).then((e=>e.connect())).then((e=>c=e))),s}async function u(){return c||await o(),c}return{getDuckDB:async function(){return i||await o(),i},getConnection:u,query:async e=>{const{type:t,sql:n}=e,r=await u(),s=await r.query(n);return"exec"===t?void 0:"arrow"===t?s:s.toArray()}}}async function Ie({log:e=!1}={}){const t=E.getJsDelivrBundles(),n=await E.selectBundle(t),r=URL.createObjectURL(new Blob([`importScripts("${n.mainWorker}");`],{type:"text/javascript"})),s=new Worker(r),i=e?new E.ConsoleLogger:new E.VoidLogger,c=new E.AsyncDuckDB(i,s);return await c.instantiate(n.mainModule,n.pthreadWorker),URL.revokeObjectURL(r),c}function Ce(e,t,{source:n,clients:r=(n?new Set([n]):void 0)}){return{meta:{type:"point"},source:n,clients:r,value:t,predicate:void 0!==t?v(e,b(t)):null}}function Ue(e,t,{source:n,clients:r=(n?new Set([n]):void 0)}){let s=null;if(t){const n=t.map((t=>{const n=t.map(((t,n)=>v(e[n],b(t))));return n.length>1?o(n):n[0]}));s=n.length>1?y(n):n[0]}return{meta:{type:"point"},source:n,clients:r,value:t,predicate:s}}function Le(e,t,{source:n,clients:r=(n?new Set([n]):void 0),bin:s,scale:i,pixelSize:o=1}){return{meta:{type:"interval",scales:i&&[i],bin:s,pixelSize:o},source:n,clients:r,value:t,predicate:null!=t?c(e,t):null}}function Oe(e,t,{source:n,clients:r=(n?new Set([n]):void 0),bin:s,scales:i=[],pixelSize:u=1}){const l=null!=t?o(e.map(((e,n)=>c(e,t[n])))):null;return{meta:{type:"interval",scales:i,bin:s,pixelSize:u},source:n,clients:r,value:t,predicate:l}}const Ne={contains:_,prefix:$,suffix:w,regexp:q};function Ge(e,t,{source:n,clients:r,method:s="contains"}){return{meta:{type:"match",method:s},source:n,clients:r,value:t,predicate:t?(0,Ne[s])(e,b(t)):null}}function De(){const e=new Set;let t,n=new Promise((e=>t=e));return{pending(t){e.add(t)},ready:t=>(e.delete(t),0===e.size),resolve(){n=new Promise((e=>{t(),t=e}))},get promise(){return n}}}function Be(e){return he(e)?function(e){const{numRows:t,numCols:n,schema:{fields:r}}=e,s={};for(let t=0;t<n;++t){const n=r[t].name;s[n]?console.warn(`Redundant column name "${n}". Skipping...`):s[n]=pe(e.getChildAt(t))}return{numRows:t,columns:s}}(e):function(e){const t=e.length;if("object"==typeof e[0]){const n=t?Object.keys(e[0]):[],r={};return n.length>0&&n.forEach((t=>{r[t]=e.map((e=>e[t]))})),{numRows:t,columns:r}}return{numRows:t,values:e}}(e)}export{$e as Coordinator,x as MosaicClient,Se as Param,ue as Priority,Re as Selection,Le as clauseInterval,Oe as clauseIntervals,Ge as clauseMatch,Ce as clausePoint,Ue as clausePoints,fe as convertArrowArrayType,pe as convertArrowColumn,de as convertArrowValue,_e as coordinator,Ee as distinct,he as isArrowTable,Ae as isParam,xe as isSelection,Me as restConnector,R as socketConnector,De as synchronizer,S as throttle,Be as toDataColumns,Te as wasmConnector};export default null;
